<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>galera原理和源码学习 | Saar&#39;s Blog</title>
  
  

  
  <link rel="alternate" href="/atom.xml" title="Saar's Blog">
  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  <!--自定义看板娘-->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="/live2d-widget/autoload.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>

  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Saar's Blog" type="application/atom+xml">
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Saar's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header material">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="material"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Saar's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;首页
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/03/27/galera%E5%8E%9F%E7%90%86/">
        galera原理和源码学习
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://www.yorzorzy.xyz" rel="nofollow">
        
          <i class="fas fa-user" aria-hidden="true"></i>
        
        <p>Saar</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2020-03-27</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/mysql/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>mysql</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            
  

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h2 id="galera原理和源码学习"><a href="#galera原理和源码学习" class="headerlink" title="galera原理和源码学习"></a>galera原理和源码学习</h2><h3 id="源码架构"><a href="#源码架构" class="headerlink" title="源码架构"></a>源码架构</h3><p>分析数据库版本： mariadb 10.1.12 + galera 25.3.14</p>
<p><img src="/images/galera-code-structure.png" alt="galera-code-structure.png"></p>
<h3 id="源码执行流程"><a href="#源码执行流程" class="headerlink" title="源码执行流程"></a>源码执行流程</h3><p><img src="/images/image-20200310105545840.png" alt="image-20200310105545840"></p>
<h3 id="一致性协议"><a href="#一致性协议" class="headerlink" title="一致性协议"></a>一致性协议</h3><p>说起totem协议，最简单的形象就是，他将多个节点组成一个令牌环。多个节点手拉手形成一个圈，大家依次的传递token。只有获取到token的节点才有发送消息的权利。简单有效的解决了在分布式系统中各个节点的同步问题，因为只有一个节点会在一个时刻发送消息，不会出现冲突。当然，如果有节点发生意外时，令牌环就会断掉，此时大家不能够通信，而是重新组建出一个新的令牌环。</p>
<h3 id="galera代码入口"><a href="#galera代码入口" class="headerlink" title="galera代码入口"></a>galera代码入口</h3><p>wsrep是mariadb提供对外的接口，通过虚函数插件的方式加载so库动态链接库的方式来加载外部函数。mariadb可以通过galera的动态链接库来调用galera中实现的函数。galera使用的一致性协议是totem协议。这个协议强一致性，但是存在分区问题。所以galera本身遇到写入冲突的时候，会将节点排出集群之外，类似于“脑裂”的问题。galera只支持innodb数据库。</p>
<p>wsrep入口在初始化mariadb数据库初始化的时候，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mysqld_main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span>  <span class="comment">// 数据库入口函数</span></span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">   The subsequent calls may take a long time : e.g. innodb log read.</span></span><br><span class="line"><span class="comment">   Thus set the long running service control manager timeout</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_WIN32) &amp;&amp; !defined(EMBEDDED_LIBRARY)</span></span><br><span class="line">  Service.SetSlowStarting(slow_start_timeout);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (init_server_components())   <span class="comment">//初始化入口</span></span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>init_server_components函数初始化：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init_server_components</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DBUG_ENTER(<span class="string">"init_server_components"</span>);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    We need to call each of these following functions to ensure that</span></span><br><span class="line"><span class="comment">    all things are initialized so that unireg_abort() doesn't fail</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  mdl_init();   <span class="comment">//初始化元数据锁</span></span><br><span class="line">  tdc_init();   <span class="comment">//Initialize table definition cache.</span></span><br><span class="line">  <span class="keyword">if</span> (hostname_cache_init())</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  query_cache_set_min_res_unit(query_cache_min_res_unit);</span><br><span class="line">  query_cache_result_size_limit(query_cache_limit);</span><br><span class="line">  <span class="comment">/* if we set size of QC non zero in config then probably we want it ON */</span></span><br><span class="line">  <span class="keyword">if</span> (query_cache_size != <span class="number">0</span> &amp;&amp;</span><br><span class="line">      global_system_variables.query_cache_type == <span class="number">0</span> &amp;&amp;</span><br><span class="line">      !IS_SYSVAR_AUTOSIZE(&amp;query_cache_size))</span><br><span class="line">  &#123;</span><br><span class="line">    global_system_variables.query_cache_type= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  query_cache_init();   <span class="comment">// query cache init</span></span><br><span class="line">  query_cache_resize(query_cache_size);           <span class="comment">//重新resize</span></span><br><span class="line">  my_rnd_init(&amp;sql_rand,(ulong) server_start_time,(ulong) server_start_time/<span class="number">2</span>);   <span class="comment">//随机数初始化</span></span><br><span class="line">  setup_fpu();</span><br><span class="line">  init_thr_lock();	<span class="comment">//初始化线程锁</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">  <span class="keyword">if</span> (init_thr_timer(thread_scheduler-&gt;max_threads + extra_max_connections))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Can't initialize timers\n"</span>);</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  my_uuid_init((ulong) (my_rnd(&amp;sql_rand))*<span class="number">12345</span>,<span class="number">12345</span>);  <span class="comment">//初始化uuid</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_REPLICATION</span></span><br><span class="line">  init_slave_list();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  wt_init();  <span class="comment">//初始化wt_wait_table</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Setup logs */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Enable old-fashioned error log, except when the user has requested</span></span><br><span class="line"><span class="comment">    help information. Since the implementation of plugin server</span></span><br><span class="line"><span class="comment">    variables the help output is now written much later.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (opt_error_log &amp;&amp; !opt_abort)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!log_error_file_ptr[<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">      fn_format(log_error_file, pidfile_name, mysql_data_home, <span class="string">".err"</span>,</span><br><span class="line">                MY_REPLACE_EXT); <span class="comment">/* replace '.&lt;domain&gt;' by '.err', bug#4997 */</span></span><br><span class="line">      SYSVAR_AUTOSIZE(log_error_file_ptr, log_error_file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      fn_format(log_error_file, log_error_file_ptr, mysql_data_home, <span class="string">".err"</span>,</span><br><span class="line">                MY_UNPACK_FILENAME | MY_SAFE_PATH);</span><br><span class="line">      log_error_file_ptr= log_error_file;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!log_error_file[<span class="number">0</span>])</span><br><span class="line">      opt_error_log= <span class="number">0</span>;                         <span class="comment">// Too long file name</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      my_bool res;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">      res= reopen_fstreams(log_error_file, <span class="built_in">stdout</span>, <span class="built_in">stderr</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      res= reopen_fstreams(log_error_file, <span class="literal">NULL</span>, <span class="built_in">stderr</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!res)</span><br><span class="line">        setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">      <span class="comment">/* Add error log to windows crash reporting. */</span></span><br><span class="line">      add_file_to_crash_report(log_error_file);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* set up the hook before initializing plugins which may use it */</span></span><br><span class="line">  error_handler_hook= my_message_sql;</span><br><span class="line">  proc_info_hook= set_thd_stage_info;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_PERFSCHEMA_STORAGE_ENGINE</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Parsing the performance schema command line option may have reported</span></span><br><span class="line"><span class="comment">    warnings/information messages.</span></span><br><span class="line"><span class="comment">    Now that the logger is finally available, and redirected</span></span><br><span class="line"><span class="comment">    to the proper file when the --log--error option is used,</span></span><br><span class="line"><span class="comment">    print the buffered messages to the log.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  buffered_logs.<span class="built_in">print</span>();</span><br><span class="line">  buffered_logs.cleanup();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_PERFSCHEMA_STORAGE_ENGINE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Now that the logger is available, redirect character set</span></span><br><span class="line"><span class="comment">    errors directly to the logger</span></span><br><span class="line"><span class="comment">    (instead of the buffered_logs used at the server startup time).</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  my_charset_error_reporter= charset_error_reporter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  xid_cache_init(); <span class="comment">//xid缓存初始化</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    initialize delegates for extension observers, errors have already</span></span><br><span class="line"><span class="comment">    been reported in the function</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (delegates_init())</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* need to configure logging before initializing storage engines */</span></span><br><span class="line">  <span class="keyword">if</span> (!opt_bin_log_used &amp;&amp; !WSREP_ON)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (opt_log_slave_updates)</span><br><span class="line">      sql_print_warning(<span class="string">"You need to use --log-bin to make "</span></span><br><span class="line">                        <span class="string">"--log-slave-updates work."</span>);</span><br><span class="line">    <span class="keyword">if</span> (binlog_format_used)</span><br><span class="line">      sql_print_warning(<span class="string">"You need to use --log-bin to make "</span></span><br><span class="line">                        <span class="string">"--binlog-format work."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check that we have not let the format to unspecified at this point */</span></span><br><span class="line">  DBUG_ASSERT((uint)global_system_variables.binlog_format &lt;=</span><br><span class="line">              array_elements(binlog_format_names)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_REPLICATION</span></span><br><span class="line">  <span class="keyword">if</span> (opt_log_slave_updates &amp;&amp; replicate_same_server_id)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (opt_bin_log)</span><br><span class="line">    &#123;</span><br><span class="line">      sql_print_error(<span class="string">"using --replicate-same-server-id in conjunction with "</span></span><br><span class="line">                      <span class="string">"--log-slave-updates is impossible, it would lead to "</span></span><br><span class="line">                      <span class="string">"infinite loops in this server."</span>);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sql_print_warning(<span class="string">"using --replicate-same-server-id in conjunction with "</span></span><br><span class="line">                        <span class="string">"--log-slave-updates would lead to infinite loops in "</span></span><br><span class="line">                        <span class="string">"this server. However this will be ignored as the "</span></span><br><span class="line">                        <span class="string">"--log-bin option is not defined."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log)  <span class="comment">//binlog日志打开？</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Reports an error and aborts, if the --log-bin's path </span></span><br><span class="line"><span class="comment">       is a directory.*/</span></span><br><span class="line">    <span class="keyword">if</span> (opt_bin_logname[<span class="number">0</span>] &amp;&amp; </span><br><span class="line">        opt_bin_logname[<span class="built_in">strlen</span>(opt_bin_logname) - <span class="number">1</span>] == FN_LIBCHAR)</span><br><span class="line">    &#123;</span><br><span class="line">      sql_print_error(<span class="string">"Path '%s' is a directory name, please specify "</span></span><br><span class="line">                      <span class="string">"a file name for --log-bin option"</span>, opt_bin_logname);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Reports an error and aborts, if the --log-bin-index's path </span></span><br><span class="line"><span class="comment">       is a directory.*/</span></span><br><span class="line">    <span class="keyword">if</span> (opt_binlog_index_name &amp;&amp; </span><br><span class="line">        opt_binlog_index_name[<span class="built_in">strlen</span>(opt_binlog_index_name) - <span class="number">1</span>] </span><br><span class="line">        == FN_LIBCHAR)</span><br><span class="line">    &#123;</span><br><span class="line">      sql_print_error(<span class="string">"Path '%s' is a directory name, please specify "</span></span><br><span class="line">                      <span class="string">"a file name for --log-bin-index option"</span>,</span><br><span class="line">                      opt_binlog_index_name);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[FN_REFLEN];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ln;</span><br><span class="line">    ln= mysql_bin_log.generate_name(opt_bin_logname, <span class="string">"-bin"</span>, <span class="number">1</span>, buf);</span><br><span class="line">    <span class="keyword">if</span> (!opt_bin_logname[<span class="number">0</span>] &amp;&amp; !opt_binlog_index_name)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        User didn't give us info to name the binlog index file.</span></span><br><span class="line"><span class="comment">        Picking `hostname`-bin.index like did in 4.x, causes replication to</span></span><br><span class="line"><span class="comment">        fail if the hostname is changed later. So, we would like to instead</span></span><br><span class="line"><span class="comment">        require a name. But as we don't want to break many existing setups, we</span></span><br><span class="line"><span class="comment">        only give warning, not error.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      sql_print_warning(<span class="string">"No argument was provided to --log-bin and "</span></span><br><span class="line">                        <span class="string">"neither --log-basename or --log-bin-index where "</span></span><br><span class="line">                        <span class="string">"used;  This may cause repliction to break when this "</span></span><br><span class="line">                        <span class="string">"server acts as a master and has its hostname "</span></span><br><span class="line">                        <span class="string">"changed! Please use '--log-basename=%s' or "</span></span><br><span class="line">                        <span class="string">"'--log-bin=%s' to avoid this problem."</span>,</span><br><span class="line">                        opt_log_basename, ln);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ln == buf)</span><br><span class="line">      opt_bin_logname= my_once_strdup(buf, MYF(MY_WME));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Wsrep initialization must happen at this point, because:</span></span><br><span class="line"><span class="comment">    - opt_bin_logname must be known when starting replication</span></span><br><span class="line"><span class="comment">      since SST may need it</span></span><br><span class="line"><span class="comment">    - SST may modify binlog index file, so it must be opened</span></span><br><span class="line"><span class="comment">      after SST has happened</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    We also (unconditionally) initialize wsrep LOCKs and CONDs.</span></span><br><span class="line"><span class="comment">    It is because they are used while accessing wsrep system</span></span><br><span class="line"><span class="comment">    variables even when a wsrep provider is not loaded.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  wsrep_thr_init();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (WSREP_ON &amp;&amp; !wsrep_recovery &amp;&amp; !opt_abort) <span class="comment">/* WSREP BEFORE SE */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (opt_bootstrap) <span class="comment">// bootsrap option given - disable wsrep functionality</span></span><br><span class="line">    &#123;</span><br><span class="line">      wsrep_provider_init(WSREP_NONE);   <span class="comment">//节点初始化</span></span><br><span class="line">      <span class="keyword">if</span> (wsrep_init())  <span class="comment">//初始化数据结构和回调函数</span></span><br><span class="line">        unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// full wsrep initialization</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// add basedir/bin to PATH to resolve wsrep script names</span></span><br><span class="line">      <span class="keyword">char</span>* <span class="keyword">const</span> tmp_path= (<span class="keyword">char</span>*)my_alloca(<span class="built_in">strlen</span>(mysql_home) +</span><br><span class="line">                                             <span class="built_in">strlen</span>(<span class="string">"/bin"</span>) + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (tmp_path)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(tmp_path, mysql_home);</span><br><span class="line">        <span class="built_in">strcat</span>(tmp_path, <span class="string">"/bin"</span>);</span><br><span class="line">        wsrep_prepend_PATH(tmp_path);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        WSREP_ERROR(<span class="string">"Could not append %s/bin to PATH"</span>, mysql_home);</span><br><span class="line">      &#125;</span><br><span class="line">      my_afree(tmp_path);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (wsrep_before_SE())</span><br><span class="line">      &#123;</span><br><span class="line">        set_ports(); <span class="comment">// this is also called in network_init() later but we need</span></span><br><span class="line">                     <span class="comment">// to know mysqld_port now - lp:1071882</span></span><br><span class="line">        wsrep_init_startup(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log) <span class="comment">//如果binlog打开，打开索引文件</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (mysql_bin_log.open_index_file(opt_binlog_index_name, opt_bin_logname,</span><br><span class="line">                                      TRUE))</span><br><span class="line">    &#123;</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log)</span><br><span class="line">  &#123;</span><br><span class="line">    log_bin_basename=</span><br><span class="line">      rpl_make_log_name(opt_bin_logname, pidfile_name,</span><br><span class="line">                        opt_bin_logname ? <span class="string">""</span> : <span class="string">"-bin"</span>);</span><br><span class="line">    log_bin_index=</span><br><span class="line">      rpl_make_log_name(opt_binlog_index_name, log_bin_basename, <span class="string">".index"</span>);</span><br><span class="line">    <span class="keyword">if</span> (log_bin_basename == <span class="literal">NULL</span> || log_bin_index == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      sql_print_error(<span class="string">"Unable to create replication path names:"</span></span><br><span class="line">                      <span class="string">" out of memory or path names too long"</span></span><br><span class="line">                      <span class="string">" (path name exceeds "</span> STRINGIFY_ARG(FN_REFLEN)</span><br><span class="line">                      <span class="string">" or file name exceeds "</span> STRINGIFY_ARG(FN_LEN) <span class="string">")."</span>);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">  DBUG_PRINT(<span class="string">"debug"</span>,</span><br><span class="line">             (<span class="string">"opt_bin_logname: %s, opt_relay_logname: %s, pidfile_name: %s"</span>,</span><br><span class="line">              opt_bin_logname, opt_relay_logname, pidfile_name));</span><br><span class="line">  <span class="keyword">if</span> (opt_relay_logname)</span><br><span class="line">  &#123;</span><br><span class="line">    relay_log_basename=</span><br><span class="line">      rpl_make_log_name(opt_relay_logname, pidfile_name,</span><br><span class="line">                        opt_relay_logname ? <span class="string">""</span> : <span class="string">"-relay-bin"</span>);</span><br><span class="line">    relay_log_index=</span><br><span class="line">      rpl_make_log_name(opt_relaylog_index_name, relay_log_basename, <span class="string">".index"</span>);</span><br><span class="line">    <span class="keyword">if</span> (relay_log_basename == <span class="literal">NULL</span> || relay_log_index == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      sql_print_error(<span class="string">"Unable to create replication path names:"</span></span><br><span class="line">                      <span class="string">" out of memory or path names too long"</span></span><br><span class="line">                      <span class="string">" (path name exceeds "</span> STRINGIFY_ARG(FN_REFLEN)</span><br><span class="line">                      <span class="string">" or file name exceeds "</span> STRINGIFY_ARG(FN_LEN) <span class="string">")."</span>);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !EMBEDDED_LIBRARY */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* call ha_init_key_cache() on all key caches to init them */</span></span><br><span class="line">  process_key_caches(&amp;ha_init_key_cache, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  init_global_table_stats(); <span class="comment">//初始化全局表统计</span></span><br><span class="line">  init_global_index_stats();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allow storage engine to give real error messages */</span></span><br><span class="line">  <span class="keyword">if</span> (ha_init_errors())</span><br><span class="line">    DBUG_RETURN(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  tc_log= <span class="number">0</span>; <span class="comment">// ha_initialize_handlerton() needs that</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (plugin_init(&amp;remaining_argc, remaining_argv,</span><br><span class="line">                  (opt_noacl ? PLUGIN_INIT_SKIP_PLUGIN_TABLE : <span class="number">0</span>) |</span><br><span class="line">                  (opt_abort ? PLUGIN_INIT_SKIP_INITIALIZATION : <span class="number">0</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    sql_print_error(<span class="string">"Failed to initialize plugins."</span>);</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  plugins_are_initialized= TRUE;  <span class="comment">/* Don't separate from init function */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* we do want to exit if there are any other unknown options */</span></span><br><span class="line">  <span class="keyword">if</span> (remaining_argc &gt; <span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> ho_error;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_option</span> <span class="title">no_opts</span>[]=</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, GET_NO_ARG, NO_ARG, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      We need to eat any 'loose' arguments first before we conclude</span></span><br><span class="line"><span class="comment">      that there are unprocessed options.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    my_getopt_skip_unknown= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ho_error= handle_options(&amp;remaining_argc, &amp;remaining_argv, no_opts,</span><br><span class="line">                                  mysqld_get_one_option)))</span><br><span class="line">      unireg_abort(ho_error);</span><br><span class="line">    <span class="comment">/* Add back the program name handle_options removes */</span></span><br><span class="line">    remaining_argc++;</span><br><span class="line">    remaining_argv--;</span><br><span class="line">    my_getopt_skip_unknown= TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (remaining_argc &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: Too many arguments (first extra is '%s').\n"</span>,</span><br><span class="line">              my_progname, remaining_argv[<span class="number">1</span>]);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (init_io_cache_encryption())</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_abort)</span><br><span class="line">    unireg_abort(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* if the errmsg.sys is not loaded, terminate to maintain behaviour */</span></span><br><span class="line">  <span class="keyword">if</span> (!DEFAULT_ERRMSGS[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    unireg_abort(<span class="number">1</span>);  </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We have to initialize the storage engines before CSV logging */</span></span><br><span class="line">  <span class="keyword">if</span> (ha_init())</span><br><span class="line">  &#123;</span><br><span class="line">    sql_print_error(<span class="string">"Can't init databases"</span>);</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_bootstrap)</span><br><span class="line">    log_output_options= LOG_FILE;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    logger.init_log_tables();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (log_output_options &amp; LOG_NONE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Issue a warining if there were specified additional options to the</span></span><br><span class="line"><span class="comment">      log-output along with NONE. Probably this wasn't what user wanted.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((log_output_options &amp; LOG_NONE) &amp;&amp; (log_output_options &amp; ~LOG_NONE))</span><br><span class="line">      sql_print_warning(<span class="string">"There were other values specified to "</span></span><br><span class="line">                        <span class="string">"log-output besides NONE. Disabling slow "</span></span><br><span class="line">                        <span class="string">"and general logs anyway."</span>);</span><br><span class="line">    logger.set_handlers(LOG_FILE, LOG_NONE, LOG_NONE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* fall back to the log files if tables are not present */</span></span><br><span class="line">    LEX_STRING csv_name=&#123;C_STRING_WITH_LEN(<span class="string">"csv"</span>)&#125;;</span><br><span class="line">    <span class="keyword">if</span> (!plugin_is_ready(&amp;csv_name, MYSQL_STORAGE_ENGINE_PLUGIN))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* purecov: begin inspected */</span></span><br><span class="line">      sql_print_error(<span class="string">"CSV engine is not present, falling back to the "</span></span><br><span class="line">                      <span class="string">"log files"</span>);</span><br><span class="line">      SYSVAR_AUTOSIZE(log_output_options, </span><br><span class="line">                      (log_output_options &amp; ~LOG_TABLE) | LOG_FILE);</span><br><span class="line">      <span class="comment">/* purecov: end */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.set_handlers(LOG_FILE,</span><br><span class="line">                        global_system_variables.sql_log_slow ?</span><br><span class="line">                        log_output_options:LOG_NONE,</span><br><span class="line">                        opt_log ? log_output_options:LOG_NONE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (init_default_storage_engine(default_storage_engine, table_plugin))</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (default_tmp_storage_engine &amp;&amp; !*default_tmp_storage_engine)</span><br><span class="line">    default_tmp_storage_engine= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enforced_storage_engine &amp;&amp; !*enforced_storage_engine)</span><br><span class="line">    enforced_storage_engine= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (init_default_storage_engine(default_tmp_storage_engine, tmp_table_plugin))</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (init_default_storage_engine(enforced_storage_engine, enforced_table_plugin))</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_ARIA_FOR_TMP_TABLES</span></span><br><span class="line">  <span class="keyword">if</span> (!ha_storage_engine_is_enabled(maria_hton) &amp;&amp; !opt_bootstrap)</span><br><span class="line">  &#123;</span><br><span class="line">    sql_print_error(<span class="string">"Aria engine is not enabled or did not start. The Aria engine must be enabled to continue as mysqld was configured with --with-aria-tmp-tables"</span>);</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_WSREP</span></span><br><span class="line">  <span class="keyword">if</span> (WSREP_ON &amp;&amp; !opt_bin_log)</span><br><span class="line">  &#123;</span><br><span class="line">    wsrep_emulate_bin_log= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  tc_log= get_tc_log_implementation();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tc_log-&gt;<span class="built_in">open</span>(opt_bin_log ? opt_bin_logname : opt_tc_log_file))</span><br><span class="line">  &#123;</span><br><span class="line">    sql_print_error(<span class="string">"Can't init tc log"</span>);</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ha_recover(<span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mutex lock is not needed here.</span></span><br><span class="line"><span class="comment">     * but to be able to have mysql_mutex_assert_owner() in code,</span></span><br><span class="line"><span class="comment">     * we do it anyway */</span></span><br><span class="line">    mysql_mutex_lock(mysql_bin_log.get_log_lock());</span><br><span class="line">    <span class="keyword">int</span> r= mysql_bin_log.<span class="built_in">open</span>(opt_bin_logname, LOG_BIN, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                              WRITE_CACHE, max_binlog_size, <span class="number">0</span>, TRUE);</span><br><span class="line">    mysql_mutex_unlock(mysql_bin_log.get_log_lock());</span><br><span class="line">    <span class="keyword">if</span> (r)</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_REPLICATION</span></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log &amp;&amp; expire_logs_days)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">time_t</span> purge_time= server_start_time - expire_logs_days*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>;</span><br><span class="line">    <span class="keyword">if</span> (purge_time &gt;= <span class="number">0</span>)</span><br><span class="line">      mysql_bin_log.purge_logs_before_date(purge_time);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_myisam_log)</span><br><span class="line">    (<span class="keyword">void</span>) mi_log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(HAVE_MLOCKALL) &amp;&amp; defined(MCL_CURRENT) &amp;&amp; !defined(EMBEDDED_LIBRARY)</span></span><br><span class="line">  <span class="keyword">if</span> (locked_in_memory)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="keyword">if</span> (user_info)</span><br><span class="line">    &#123;</span><br><span class="line">      DBUG_ASSERT(!getuid());</span><br><span class="line">      <span class="keyword">if</span> (setreuid((<span class="keyword">uid_t</span>) <span class="number">-1</span>, <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        sql_perror(<span class="string">"setreuid"</span>);</span><br><span class="line">        unireg_abort(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      error= mlockall(MCL_CURRENT);</span><br><span class="line">      set_user(mysqld_user, user_info);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      error= mlockall(MCL_CURRENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (global_system_variables.log_warnings)</span><br><span class="line">	sql_print_warning(<span class="string">"Failed to lock memory. Errno: %d\n"</span>,errno);</span><br><span class="line">      locked_in_memory= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  locked_in_memory= <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  ft_init_stopwords();</span><br><span class="line"></span><br><span class="line">  init_max_user_conn();  <span class="comment">//初始化最大用户链接数目</span></span><br><span class="line">  init_update_queries(); <span class="comment">// 初始化update queries</span></span><br><span class="line">  init_global_user_stats();</span><br><span class="line">  init_global_client_stats();</span><br><span class="line">  <span class="keyword">if</span> (!opt_bootstrap)</span><br><span class="line">    servers_init(<span class="number">0</span>);</span><br><span class="line">  init_status_vars();</span><br><span class="line">  DBUG_RETURN(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wsrep_init初始化：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wsrep_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rcode= <span class="number">-1</span>;</span><br><span class="line">  DBUG_ASSERT(wsrep_inited == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(wsrep_start_position, WSREP_START_POSITION_ZERO))</span><br><span class="line">    wsrep_start_position_init(wsrep_start_position);  <span class="comment">//初始化启动位置，扫描uuid和seqno</span></span><br><span class="line"></span><br><span class="line">  wsrep_sst_auth_init(wsrep_sst_auth);  <span class="comment">// 同步数据认证</span></span><br><span class="line"></span><br><span class="line">  wsrep_causal_reads_update(&amp;global_system_variables); <span class="comment">// wsrep_sync_wait状态更新</span></span><br><span class="line"></span><br><span class="line">  wsrep_ready_set(FALSE);</span><br><span class="line">  assert(wsrep_provider);</span><br><span class="line"></span><br><span class="line">  wsrep_init_position();  <span class="comment">//根据获取到的uuid和seqno启动位置</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((rcode= wsrep_load(wsrep_provider, &amp;wsrep, wsrep_log_cb)) != WSREP_OK)  <span class="comment">//wsrep_provider加载</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(wsrep_provider, WSREP_NONE))</span><br><span class="line">    &#123;</span><br><span class="line">      WSREP_ERROR(<span class="string">"wsrep_load(%s) failed: %s (%d). Reverting to no provider."</span>,</span><br><span class="line">                  wsrep_provider, strerror(rcode), rcode);</span><br><span class="line">      <span class="built_in">strcpy</span>((<span class="keyword">char</span>*)wsrep_provider, WSREP_NONE); <span class="comment">// damn it's a dirty hack</span></span><br><span class="line">      (<span class="keyword">void</span>) wsrep_init();</span><br><span class="line">      <span class="keyword">return</span> rcode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* this is for recursive call above */</span></span><br><span class="line">    &#123;</span><br><span class="line">      WSREP_ERROR(<span class="string">"Could not revert to no provider: %s (%d). Need to abort."</span>,</span><br><span class="line">                  strerror(rcode), rcode);</span><br><span class="line">      unireg_abort(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!WSREP_PROVIDER_EXISTS) <span class="comment">//如果不存在初始化</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// enable normal operation in case no provider is specified</span></span><br><span class="line">    wsrep_ready_set(TRUE);</span><br><span class="line">    wsrep_inited= <span class="number">1</span>;</span><br><span class="line">    global_system_variables.wsrep_on = <span class="number">0</span>;</span><br><span class="line">    wsrep_init_args args;</span><br><span class="line">    args.logger_cb = wsrep_log_cb;</span><br><span class="line">    args.options = (wsrep_provider_options) ?</span><br><span class="line">            wsrep_provider_options : <span class="string">""</span>;</span><br><span class="line">    rcode = wsrep-&gt;init(wsrep, &amp;args);</span><br><span class="line">    <span class="keyword">if</span> (rcode)</span><br><span class="line">    &#123;</span><br><span class="line">      DBUG_PRINT(<span class="string">"wsrep"</span>,(<span class="string">"wsrep::init() failed: %d"</span>, rcode));</span><br><span class="line">      WSREP_ERROR(<span class="string">"wsrep::init() failed: %d, must shutdown"</span>, rcode);</span><br><span class="line">      wsrep-&gt;<span class="built_in">free</span>(wsrep);</span><br><span class="line">      <span class="built_in">free</span>(wsrep);</span><br><span class="line">      wsrep = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rcode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    global_system_variables.wsrep_on = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(provider_name,</span><br><span class="line">            wsrep-&gt;provider_name,    <span class="keyword">sizeof</span>(provider_name) - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(provider_version,</span><br><span class="line">            wsrep-&gt;provider_version, <span class="keyword">sizeof</span>(provider_version) - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(provider_vendor,</span><br><span class="line">            wsrep-&gt;provider_vendor,  <span class="keyword">sizeof</span>(provider_vendor) - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Initialize node address */</span></span><br><span class="line">  <span class="keyword">char</span> node_addr[<span class="number">512</span>]= &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">  <span class="keyword">size_t</span> <span class="keyword">const</span> node_addr_max= <span class="keyword">sizeof</span>(node_addr) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (!wsrep_node_address || !<span class="built_in">strcmp</span>(wsrep_node_address, <span class="string">""</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">size_t</span> <span class="keyword">const</span> ret= wsrep_guess_ip(node_addr, node_addr_max);</span><br><span class="line">    <span class="keyword">if</span> (!(ret &gt; <span class="number">0</span> &amp;&amp; ret &lt; node_addr_max))</span><br><span class="line">    &#123;</span><br><span class="line">      WSREP_WARN(<span class="string">"Failed to guess base node address. Set it explicitly via "</span></span><br><span class="line">                 <span class="string">"wsrep_node_address."</span>);</span><br><span class="line">      node_addr[<span class="number">0</span>]= <span class="string">'\0'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strncpy</span>(node_addr, wsrep_node_address, node_addr_max);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Initialize node's incoming address */</span></span><br><span class="line">  <span class="keyword">char</span> inc_addr[<span class="number">512</span>]= &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">  <span class="keyword">size_t</span> <span class="keyword">const</span> inc_addr_max= <span class="keyword">sizeof</span> (inc_addr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    In case wsrep_node_incoming_address is either not set or set to AUTO,</span></span><br><span class="line"><span class="comment">    we need to use mysqld's my_bind_addr_str:mysqld_port, lastly fallback</span></span><br><span class="line"><span class="comment">    to wsrep_node_address' value if mysqld's bind-address is not set either.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> ((!wsrep_node_incoming_address ||</span><br><span class="line">       !<span class="built_in">strcmp</span> (wsrep_node_incoming_address, WSREP_NODE_INCOMING_AUTO)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">bool</span> is_ipv6= <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> my_bind_ip= INADDR_ANY; <span class="comment">// default if not set</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (my_bind_addr_str &amp;&amp; <span class="built_in">strlen</span>(my_bind_addr_str))</span><br><span class="line">    &#123;</span><br><span class="line">      my_bind_ip= wsrep_check_ip(my_bind_addr_str, &amp;is_ipv6);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (INADDR_ANY != my_bind_ip)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        If its a not a valid address, leave inc_addr as empty string. mysqld</span></span><br><span class="line"><span class="comment">        is not listening for client connections on network interfaces.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (INADDR_NONE != my_bind_ip &amp;&amp; INADDR_LOOPBACK != my_bind_ip)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *fmt= (is_ipv6) ? <span class="string">"[%s]:%u"</span> : <span class="string">"%s:%u"</span>;</span><br><span class="line">        <span class="built_in">snprintf</span>(inc_addr, inc_addr_max, fmt, my_bind_addr_str, mysqld_port);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* mysqld binds to 0.0.0.0, try taking IP from wsrep_node_address. */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">size_t</span> <span class="keyword">const</span> node_addr_len= <span class="built_in">strlen</span>(node_addr);</span><br><span class="line">      <span class="keyword">if</span> (node_addr_len &gt; <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        wsp::<span class="function">Address <span class="title">addr</span><span class="params">(node_addr)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!addr.is_valid())</span><br><span class="line">        &#123;</span><br><span class="line">          WSREP_DEBUG(<span class="string">"Could not parse node address : %s"</span>, node_addr);</span><br><span class="line">          WSREP_WARN(<span class="string">"Guessing address for incoming client connections failed. "</span></span><br><span class="line">                     <span class="string">"Try setting wsrep_node_incoming_address explicitly."</span>);</span><br><span class="line">          <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *fmt= (addr.is_ipv6()) ? <span class="string">"[%s]:%u"</span> : <span class="string">"%s:%u"</span>;</span><br><span class="line">        <span class="built_in">snprintf</span>(inc_addr, inc_addr_max, fmt, addr.get_address(),</span><br><span class="line">                 (<span class="keyword">int</span>) mysqld_port);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    wsp::Address addr(wsrep_node_incoming_address);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!addr.is_valid())</span><br><span class="line">    &#123;</span><br><span class="line">      WSREP_WARN(<span class="string">"Could not parse wsrep_node_incoming_address : %s"</span>,</span><br><span class="line">                 wsrep_node_incoming_address);</span><br><span class="line">      <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      In case port is not specified in wsrep_node_incoming_address, we use</span></span><br><span class="line"><span class="comment">      mysqld_port.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">int</span> port= (addr.get_port() &gt; <span class="number">0</span>) ? addr.get_port() : (<span class="keyword">int</span>) mysqld_port;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *fmt= (addr.is_ipv6()) ? <span class="string">"[%s]:%u"</span> : <span class="string">"%s:%u"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(inc_addr, inc_addr_max, fmt, addr.get_address(), port);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">wsrep_init_args</span> <span class="title">wsrep_args</span>;</span> <span class="comment">//初始化启动参数数据结构</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">wsrep_gtid</span> <span class="title">const</span> <span class="title">state_id</span> = &#123;</span> local_uuid, local_seqno &#125;;</span><br><span class="line"></span><br><span class="line">  wsrep_args.data_dir        = wsrep_data_home_dir;</span><br><span class="line">  wsrep_args.node_name       = (wsrep_node_name) ? wsrep_node_name : <span class="string">""</span>;</span><br><span class="line">  wsrep_args.node_address    = node_addr;</span><br><span class="line">  wsrep_args.node_incoming   = inc_addr;</span><br><span class="line">  wsrep_args.options         = (wsrep_provider_options) ?</span><br><span class="line">                                wsrep_provider_options : <span class="string">""</span>;</span><br><span class="line">  wsrep_args.proto_ver       = wsrep_max_protocol_version;</span><br><span class="line"></span><br><span class="line">  wsrep_args.state_id        = &amp;state_id;</span><br><span class="line"></span><br><span class="line">  wsrep_args.logger_cb       = wsrep_log_cb;</span><br><span class="line">  wsrep_args.view_handler_cb = wsrep_view_handler_cb;</span><br><span class="line">  wsrep_args.apply_cb        = wsrep_apply_cb;</span><br><span class="line">  wsrep_args.commit_cb       = wsrep_commit_cb;</span><br><span class="line">  wsrep_args.unordered_cb    = wsrep_unordered_cb;</span><br><span class="line">  wsrep_args.sst_donate_cb   = wsrep_sst_donate_cb;</span><br><span class="line">  wsrep_args.synced_cb       = wsrep_synced_cb;</span><br><span class="line"></span><br><span class="line">  rcode = wsrep-&gt;init(wsrep, &amp;wsrep_args);  <span class="comment">//调用接口告诉galera这些信息</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rcode)</span><br><span class="line">  &#123;</span><br><span class="line">    DBUG_PRINT(<span class="string">"wsrep"</span>,(<span class="string">"wsrep::init() failed: %d"</span>, rcode));</span><br><span class="line">    WSREP_ERROR(<span class="string">"wsrep::init() failed: %d, must shutdown"</span>, rcode);</span><br><span class="line">    wsrep-&gt;<span class="built_in">free</span>(wsrep);</span><br><span class="line">    <span class="built_in">free</span>(wsrep);</span><br><span class="line">    wsrep = <span class="literal">NULL</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    wsrep_inited= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化的过程基本结束，主要初始化的过程在这个地方实现。</p>
<p>数据库执行语句的时候，在函数dispatcher_command函数中执行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">dispatch_command</span><span class="params">(<span class="keyword">enum</span> enum_server_command command, THD *thd,</span></span></span><br><span class="line"><span class="function"><span class="params">		      <span class="keyword">char</span>* packet, uint packet_length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NET *net= &amp;thd-&gt;net;</span><br><span class="line">  <span class="keyword">bool</span> error= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">bool</span> do_end_of_statement= <span class="literal">true</span>;</span><br><span class="line">  DBUG_ENTER(<span class="string">"dispatch_command"</span>);</span><br><span class="line">  DBUG_PRINT(<span class="string">"info"</span>, (<span class="string">"command: %d"</span>, command));</span><br><span class="line"></span><br><span class="line">  inc_thread_running();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_WSREP    <span class="comment">// 开启了wsrep的话继续走</span></span></span><br><span class="line">  <span class="keyword">if</span> (WSREP(thd))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!thd-&gt;in_multi_stmt_transaction_mode())</span><br><span class="line">    &#123;</span><br><span class="line">      thd-&gt;wsrep_PA_safe= <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysql_mutex_lock(&amp;thd-&gt;LOCK_wsrep_thd);</span><br><span class="line">    thd-&gt;wsrep_query_state= QUERY_EXEC;</span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;wsrep_conflict_state== RETRY_AUTOCOMMIT)</span><br><span class="line">    &#123;</span><br><span class="line">      thd-&gt;wsrep_conflict_state= NO_CONFLICT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;wsrep_conflict_state== MUST_ABORT)</span><br><span class="line">    &#123;</span><br><span class="line">      wsrep_client_rollback(thd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;wsrep_conflict_state== ABORTED)</span><br><span class="line">    &#123;</span><br><span class="line">      my_error(ER_LOCK_DEADLOCK, MYF(<span class="number">0</span>), <span class="string">"wsrep aborted transaction"</span>);</span><br><span class="line">      WSREP_DEBUG(<span class="string">"Deadlock error for: %s"</span>, thd-&gt;query());</span><br><span class="line">      mysql_mutex_unlock(&amp;thd-&gt;LOCK_wsrep_thd);</span><br><span class="line">      thd-&gt;killed               = NOT_KILLED;</span><br><span class="line">      thd-&gt;mysys_var-&gt;<span class="built_in">abort</span>     = <span class="number">0</span>;</span><br><span class="line">      thd-&gt;wsrep_conflict_state = NO_CONFLICT;</span><br><span class="line">      thd-&gt;wsrep_retry_counter  = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">goto</span> dispatch_end;</span><br><span class="line">    &#125;</span><br><span class="line">    mysql_mutex_unlock(&amp;thd-&gt;LOCK_wsrep_thd);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_WSREP */</span>   <span class="comment">//wsrep结束</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ENABLED_PROFILING)</span></span><br><span class="line">  thd-&gt;profiling.start_new_query();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  MYSQL_COMMAND_START(thd-&gt;thread_id, command,</span><br><span class="line">                      &amp;thd-&gt;security_ctx-&gt;priv_user[<span class="number">0</span>],</span><br><span class="line">                      (<span class="keyword">char</span> *) thd-&gt;security_ctx-&gt;host_or_ip);</span><br><span class="line">  </span><br><span class="line">  DBUG_EXECUTE_IF(<span class="string">"crash_dispatch_command_before"</span>,</span><br><span class="line">                  &#123; DBUG_PRINT(<span class="string">"crash_dispatch_command_before"</span>, (<span class="string">"now"</span>));</span><br><span class="line">                    DBUG_ABORT(); &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Performance Schema Interface instrumentation, begin */</span></span><br><span class="line">  thd-&gt;m_statement_psi= MYSQL_REFINE_STATEMENT(thd-&gt;m_statement_psi,</span><br><span class="line">                                               com_statement_info[command].</span><br><span class="line">                                               m_key);</span><br><span class="line">  thd-&gt;set_command(command);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Commands which always take a long time are logged into</span></span><br><span class="line"><span class="comment">    the slow log only if opt_log_slow_admin_statements is set.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  thd-&gt;enable_slow_log= thd-&gt;variables.sql_log_slow;</span><br><span class="line">  thd-&gt;query_plan_flags= QPLAN_INIT;</span><br><span class="line">  thd-&gt;lex-&gt;sql_command= SQLCOM_END; <span class="comment">/* to avoid confusing VIEW detectors */</span></span><br><span class="line">  thd-&gt;reset_kill_query();</span><br><span class="line"></span><br><span class="line">  DEBUG_SYNC(thd,<span class="string">"dispatch_command_before_set_time"</span>);</span><br><span class="line"></span><br><span class="line">  thd-&gt;set_time();</span><br><span class="line">  <span class="keyword">if</span> (!(server_command_flags[command] &amp; CF_SKIP_QUERY_ID))</span><br><span class="line">    thd-&gt;set_query_id(next_query_id());</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      ping, get statistics or similar stateless command.</span></span><br><span class="line"><span class="comment">      No reason to increase query id here.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    thd-&gt;set_query_id(get_query_id());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(server_command_flags[command] &amp; CF_SKIP_QUESTIONS))</span><br><span class="line">    statistic_increment(thd-&gt;status_var.questions, &amp;LOCK_status);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Copy data for user stats */</span></span><br><span class="line">  <span class="keyword">if</span> ((thd-&gt;userstat_running= opt_userstat_running))</span><br><span class="line">  &#123;</span><br><span class="line">    thd-&gt;start_cpu_time= my_getcputime();</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;thd-&gt;org_status_var, &amp;thd-&gt;status_var, <span class="keyword">sizeof</span>(thd-&gt;status_var));</span><br><span class="line">    thd-&gt;select_commands= thd-&gt;update_commands= thd-&gt;other_commands= <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    Clear the set of flags that are expected to be cleared at the</span></span><br><span class="line"><span class="comment">    beginning of each command.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  thd-&gt;server_status&amp;= ~SERVER_STATUS_CLEAR_SET;</span><br><span class="line">  <span class="keyword">switch</span> (command) &#123;</span><br><span class="line">  <span class="keyword">case</span> COM_INIT_DB:</span><br><span class="line">  &#123;</span><br><span class="line">    LEX_STRING tmp;</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_CHANGE_DB]);</span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;copy_with_error(system_charset_info, &amp;tmp,</span><br><span class="line">                             thd-&gt;charset(), packet, packet_length))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mysql_change_db(thd, &amp;tmp, FALSE))</span><br><span class="line">    &#123;</span><br><span class="line">      general_log_write(thd, command, thd-&gt;db, thd-&gt;db_length);</span><br><span class="line">      my_ok(thd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_REPLICATION</span></span><br><span class="line">  <span class="keyword">case</span> COM_REGISTER_SLAVE:</span><br><span class="line">  &#123;</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_register_slave);</span><br><span class="line">    <span class="keyword">if</span> (!register_slave(thd, (uchar*)packet, packet_length))</span><br><span class="line">      my_ok(thd);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">case</span> COM_CHANGE_USER:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> auth_rc;</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_other);</span><br><span class="line"></span><br><span class="line">    thd-&gt;change_user();</span><br><span class="line">    thd-&gt;clear_error();                         <span class="comment">// if errors from rollback</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* acl_authenticate() takes the data from net-&gt;read_pos */</span></span><br><span class="line">    net-&gt;read_pos= (uchar*)packet;</span><br><span class="line"></span><br><span class="line">    uint save_db_length= thd-&gt;db_length;</span><br><span class="line">    <span class="keyword">char</span> *save_db= thd-&gt;db;</span><br><span class="line">    USER_CONN *save_user_connect= thd-&gt;user_connect;</span><br><span class="line">    Security_context save_security_ctx= *thd-&gt;security_ctx;</span><br><span class="line">    CHARSET_INFO *save_character_set_client=</span><br><span class="line">      thd-&gt;variables.character_set_client;</span><br><span class="line">    CHARSET_INFO *save_collation_connection=</span><br><span class="line">      thd-&gt;variables.collation_connection;</span><br><span class="line">    CHARSET_INFO *save_character_set_results=</span><br><span class="line">      thd-&gt;variables.character_set_results;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Ensure we don't free security_ctx-&gt;user in case we have to revert */</span></span><br><span class="line">    thd-&gt;security_ctx-&gt;user= <span class="number">0</span>;</span><br><span class="line">    thd-&gt;user_connect= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      to limit COM_CHANGE_USER ability to brute-force passwords,</span></span><br><span class="line"><span class="comment">      we only allow three unsuccessful COM_CHANGE_USER per connection.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;failed_com_change_user &gt;= <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      my_message(ER_UNKNOWN_COM_ERROR, ER_THD(thd,ER_UNKNOWN_COM_ERROR),</span><br><span class="line">                 MYF(<span class="number">0</span>));</span><br><span class="line">      auth_rc= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      auth_rc= acl_authenticate(thd, packet_length);</span><br><span class="line"></span><br><span class="line">    mysql_audit_notify_connection_change_user(thd);</span><br><span class="line">    <span class="keyword">if</span> (auth_rc)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Free user if allocated by acl_authenticate */</span></span><br><span class="line">      my_free(thd-&gt;security_ctx-&gt;user);</span><br><span class="line">      *thd-&gt;security_ctx= save_security_ctx;</span><br><span class="line">      <span class="keyword">if</span> (thd-&gt;user_connect)</span><br><span class="line">	decrease_user_connections(thd-&gt;user_connect);</span><br><span class="line">      thd-&gt;user_connect= save_user_connect;</span><br><span class="line">      thd-&gt;reset_db(save_db, save_db_length);</span><br><span class="line">      thd-&gt;variables.character_set_client= save_character_set_client;</span><br><span class="line">      thd-&gt;variables.collation_connection= save_collation_connection;</span><br><span class="line">      thd-&gt;variables.character_set_results= save_character_set_results;</span><br><span class="line">      thd-&gt;update_charset();</span><br><span class="line">      thd-&gt;failed_com_change_user++;</span><br><span class="line">      my_sleep(<span class="number">1000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">#ifndef NO_EMBEDDED_ACCESS_CHECKS</span><br><span class="line">      <span class="comment">/* we've authenticated new user */</span></span><br><span class="line">      <span class="keyword">if</span> (save_user_connect)</span><br><span class="line">	decrease_user_connections(save_user_connect);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NO_EMBEDDED_ACCESS_CHECKS */</span></span></span><br><span class="line">      my_free(save_db);</span><br><span class="line">      my_free(save_security_ctx.user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_STMT_EXECUTE:</span><br><span class="line">  &#123;</span><br><span class="line">    mysqld_stmt_execute(thd, packet, packet_length);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_STMT_FETCH:</span><br><span class="line">  &#123;</span><br><span class="line">    mysqld_stmt_fetch(thd, packet, packet_length);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_STMT_SEND_LONG_DATA:</span><br><span class="line">  &#123;</span><br><span class="line">    mysql_stmt_get_longdata(thd, packet, packet_length);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_STMT_PREPARE:</span><br><span class="line">  &#123;</span><br><span class="line">    mysqld_stmt_prepare(thd, packet, packet_length);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_STMT_CLOSE:</span><br><span class="line">  &#123;</span><br><span class="line">    mysqld_stmt_close(thd, packet);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_STMT_RESET:</span><br><span class="line">  &#123;</span><br><span class="line">    mysqld_stmt_reset(thd, packet);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_QUERY: <span class="comment">//查询语句</span></span><br><span class="line">  &#123;</span><br><span class="line">      </span><br><span class="line">    DBUG_ASSERT(thd-&gt;m_digest == <span class="literal">NULL</span>);</span><br><span class="line">    thd-&gt;m_digest= &amp; thd-&gt;m_digest_state;</span><br><span class="line">    thd-&gt;m_digest-&gt;reset(thd-&gt;m_token_array, max_digest_length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (alloc_query(thd, packet, packet_length))</span><br><span class="line">      <span class="keyword">break</span>;					<span class="comment">// fatal error is set</span></span><br><span class="line">    MYSQL_QUERY_START(thd-&gt;query(), thd-&gt;thread_id,</span><br><span class="line">                      (<span class="keyword">char</span> *) (thd-&gt;db ? thd-&gt;db : <span class="string">""</span>),</span><br><span class="line">                      &amp;thd-&gt;security_ctx-&gt;priv_user[<span class="number">0</span>],</span><br><span class="line">                      (<span class="keyword">char</span> *) thd-&gt;security_ctx-&gt;host_or_ip);</span><br><span class="line">    <span class="keyword">char</span> *packet_end= thd-&gt;query() + thd-&gt;query_length();</span><br><span class="line">    general_log_write(thd, command, thd-&gt;query(), thd-&gt;query_length());</span><br><span class="line">    DBUG_PRINT(<span class="string">"query"</span>,(<span class="string">"%-.4096s"</span>,thd-&gt;query()));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ENABLED_PROFILING)</span></span><br><span class="line">    thd-&gt;profiling.set_query_source(thd-&gt;query(), thd-&gt;query_length());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    MYSQL_SET_STATEMENT_TEXT(thd-&gt;m_statement_psi, thd-&gt;query(),</span><br><span class="line">                             thd-&gt;query_length());</span><br><span class="line"></span><br><span class="line">    Parser_state parser_state;</span><br><span class="line">    <span class="keyword">if</span> (parser_state.init(thd, thd-&gt;query(), thd-&gt;query_length()))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WSREP_ON)</span><br><span class="line">      wsrep_mysql_parse(thd, thd-&gt;query(), thd-&gt;query_length(), &amp;parser_state);   <span class="comment">//wsrep_mysql_parse执行</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      mysql_parse(thd, thd-&gt;query(), thd-&gt;query_length(), &amp;parser_state); <span class="comment">//否则使用mysql_parse执行</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!thd-&gt;killed &amp;&amp; (parser_state.m_lip.found_semicolon != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">           ! thd-&gt;is_error())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Multiple queries exist, execute them individually</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">char</span> *beginning_of_next_stmt= (<span class="keyword">char</span>*) parser_state.m_lip.found_semicolon;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_ARIA_STORAGE_ENGINE</span></span><br><span class="line">    ha_maria::implicit_commit(thd, FALSE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Finalize server status flags after executing a statement. */</span></span><br><span class="line">      thd-&gt;update_server_status();</span><br><span class="line">      thd-&gt;protocol-&gt;end_statement();</span><br><span class="line">      query_cache_end_of_result(thd);</span><br><span class="line"></span><br><span class="line">      mysql_audit_general(thd, MYSQL_AUDIT_GENERAL_STATUS,</span><br><span class="line">                          thd-&gt;get_stmt_da()-&gt;is_error()</span><br><span class="line">                            ? thd-&gt;get_stmt_da()-&gt;sql_errno()</span><br><span class="line">                            : <span class="number">0</span>,</span><br><span class="line">                          command_name[command].str);</span><br><span class="line"></span><br><span class="line">      ulong length= (ulong)(packet_end - beginning_of_next_stmt);</span><br><span class="line"></span><br><span class="line">      log_slow_statement(thd);</span><br><span class="line">      DBUG_ASSERT(!thd-&gt;apc_target.is_enabled());</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Remove garbage at start of query */</span></span><br><span class="line">      <span class="keyword">while</span> (length &gt; <span class="number">0</span> &amp;&amp; my_isspace(thd-&gt;charset(), *beginning_of_next_stmt))</span><br><span class="line">      &#123;</span><br><span class="line">        beginning_of_next_stmt++;</span><br><span class="line">        length--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* PSI end */</span></span><br><span class="line">      MYSQL_END_STATEMENT(thd-&gt;m_statement_psi, thd-&gt;get_stmt_da());</span><br><span class="line">      thd-&gt;m_statement_psi= <span class="literal">NULL</span>;</span><br><span class="line">      thd-&gt;m_digest= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* DTRACE end */</span></span><br><span class="line">      <span class="keyword">if</span> (MYSQL_QUERY_DONE_ENABLED())</span><br><span class="line">      &#123;</span><br><span class="line">        MYSQL_QUERY_DONE(thd-&gt;is_error());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ENABLED_PROFILING)</span></span><br><span class="line">      thd-&gt;profiling.finish_current_query();</span><br><span class="line">      thd-&gt;profiling.start_new_query(<span class="string">"continuing"</span>);</span><br><span class="line">      thd-&gt;profiling.set_query_source(beginning_of_next_stmt, length);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* DTRACE begin */</span></span><br><span class="line">      MYSQL_QUERY_START(beginning_of_next_stmt, thd-&gt;thread_id,</span><br><span class="line">                        (<span class="keyword">char</span> *) (thd-&gt;db ? thd-&gt;db : <span class="string">""</span>),</span><br><span class="line">                        &amp;thd-&gt;security_ctx-&gt;priv_user[<span class="number">0</span>],</span><br><span class="line">                        (<span class="keyword">char</span> *) thd-&gt;security_ctx-&gt;host_or_ip);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* PSI begin */</span></span><br><span class="line">      thd-&gt;m_digest= &amp; thd-&gt;m_digest_state;</span><br><span class="line"></span><br><span class="line">      thd-&gt;m_statement_psi= MYSQL_START_STATEMENT(&amp;thd-&gt;m_statement_state,</span><br><span class="line">                                                  com_statement_info[command].m_key,</span><br><span class="line">                                                  thd-&gt;db, thd-&gt;db_length,</span><br><span class="line">                                                  thd-&gt;charset());</span><br><span class="line">      THD_STAGE_INFO(thd, stage_init);</span><br><span class="line">      MYSQL_SET_STATEMENT_TEXT(thd-&gt;m_statement_psi, beginning_of_next_stmt,</span><br><span class="line">                               length);</span><br><span class="line"></span><br><span class="line">      thd-&gt;set_query_and_id(beginning_of_next_stmt, length,</span><br><span class="line">                            thd-&gt;charset(), next_query_id());</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Count each statement from the client.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      statistic_increment(thd-&gt;status_var.questions, &amp;LOCK_status);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!WSREP(thd))</span><br><span class="line">	thd-&gt;set_time(); <span class="comment">/* Reset the query start time. */</span></span><br><span class="line"></span><br><span class="line">      parser_state.reset(beginning_of_next_stmt, length);</span><br><span class="line">      <span class="comment">/* <span class="doctag">TODO:</span> set thd-&gt;lex-&gt;sql_command to SQLCOM_END here */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (WSREP_ON)</span><br><span class="line">        wsrep_mysql_parse(thd, beginning_of_next_stmt, length, &amp;parser_state);   <span class="comment">//执行wsrep_mysql_parse</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        mysql_parse(thd, beginning_of_next_stmt, length, &amp;parser_state);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DBUG_PRINT(<span class="string">"info"</span>,(<span class="string">"query ready"</span>));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_FIELD_LIST:				<span class="comment">// This isn't actually needed</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DONT_ALLOW_SHOW_COMMANDS</span></span><br><span class="line">    my_message(ER_NOT_ALLOWED_COMMAND, ER_THD(thd, ER_NOT_ALLOWED_COMMAND),</span><br><span class="line">               MYF(<span class="number">0</span>));	<span class="comment">/* purecov: inspected */</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> *fields, *packet_end= packet + packet_length, *arg_end;</span><br><span class="line">    <span class="comment">/* Locked closure of all tables */</span></span><br><span class="line">    TABLE_LIST table_list;</span><br><span class="line">    LEX_STRING table_name;</span><br><span class="line">    LEX_STRING db;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      SHOW statements should not add the used tables to the list of tables</span></span><br><span class="line"><span class="comment">      used in a transaction.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    MDL_savepoint mdl_savepoint= thd-&gt;mdl_context.mdl_savepoint();</span><br><span class="line"></span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_SHOW_FIELDS]);</span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;copy_db_to(&amp;db.str, &amp;db.length))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      We have name + wildcard in packet, separated by endzero</span></span><br><span class="line"><span class="comment">      (The packet is guaranteed to end with an end zero)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    arg_end= strend(packet);</span><br><span class="line">    uint arg_length= arg_end - packet;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check given table name length. */</span></span><br><span class="line">    <span class="keyword">if</span> (packet_length - arg_length &gt; NAME_LEN + <span class="number">1</span> || arg_length &gt; SAFE_NAME_LEN)</span><br><span class="line">    &#123;</span><br><span class="line">      my_message(ER_UNKNOWN_COM_ERROR, ER_THD(thd, ER_UNKNOWN_COM_ERROR),</span><br><span class="line">                 MYF(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    thd-&gt;convert_string(&amp;table_name, system_charset_info,</span><br><span class="line">			packet, arg_length, thd-&gt;charset());</span><br><span class="line">    <span class="keyword">if</span> (check_table_name(table_name.str, table_name.length, FALSE))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* this is OK due to convert_string() null-terminating the string */</span></span><br><span class="line">      my_error(ER_WRONG_TABLE_NAME, MYF(<span class="number">0</span>), table_name.str);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    packet= arg_end + <span class="number">1</span>;</span><br><span class="line">    thd-&gt;reset_for_next_command();</span><br><span class="line">    lex_start(thd);</span><br><span class="line">    <span class="comment">/* Must be before we init the table list. */</span></span><br><span class="line">    <span class="keyword">if</span> (lower_case_table_names)</span><br><span class="line">    &#123;</span><br><span class="line">      table_name.length= my_casedn_str(files_charset_info, table_name.str);</span><br><span class="line">      db.length= my_casedn_str(files_charset_info, db.str);</span><br><span class="line">    &#125;</span><br><span class="line">    table_list.init_one_table(db.str, db.length, table_name.str,</span><br><span class="line">                              table_name.length, table_name.str, TL_READ);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Init TABLE_LIST members necessary when the undelrying</span></span><br><span class="line"><span class="comment">      table is view.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    table_list.select_lex= &amp;(thd-&gt;lex-&gt;select_lex);</span><br><span class="line">    thd-&gt;lex-&gt;</span><br><span class="line">      select_lex.table_list.link_in_list(&amp;table_list,</span><br><span class="line">                                         &amp;table_list.next_local);</span><br><span class="line">    thd-&gt;lex-&gt;add_to_query_tables(&amp;table_list);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_infoschema_db(table_list.db, table_list.db_length))</span><br><span class="line">    &#123;</span><br><span class="line">      ST_SCHEMA_TABLE *schema_table= find_schema_table(thd, table_list.alias);</span><br><span class="line">      <span class="keyword">if</span> (schema_table)</span><br><span class="line">        table_list.schema_table= schema_table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint query_length= (uint) (packet_end - packet); <span class="comment">// Don't count end \0</span></span><br><span class="line">    <span class="keyword">if</span> (!(fields= (<span class="keyword">char</span> *) thd-&gt;memdup(packet, query_length + <span class="number">1</span>)))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    thd-&gt;set_query(fields, query_length);</span><br><span class="line">    general_log_print(thd, command, <span class="string">"%s %s"</span>, table_list.table_name, fields);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (open_temporary_tables(thd, &amp;table_list))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_table_access(thd, SELECT_ACL, &amp;table_list,</span><br><span class="line">                           TRUE, UINT_MAX, FALSE))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Turn on an optimization relevant if the underlying table</span></span><br><span class="line"><span class="comment">      is a view: do not fill derived tables.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    thd-&gt;lex-&gt;sql_command= SQLCOM_SHOW_FIELDS;</span><br><span class="line"></span><br><span class="line">    mysqld_list_fields(thd,&amp;table_list,fields);</span><br><span class="line">    thd-&gt;lex-&gt;unit.cleanup();</span><br><span class="line">    <span class="comment">/* No need to rollback statement transaction, it's not started. */</span></span><br><span class="line">    DBUG_ASSERT(thd-&gt;transaction.stmt.is_empty());</span><br><span class="line">    close_thread_tables(thd);</span><br><span class="line">    thd-&gt;mdl_context.rollback_to_savepoint(mdl_savepoint);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;transaction_rollback_request)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Transaction rollback was requested since MDL deadlock was</span></span><br><span class="line"><span class="comment">        discovered while trying to open tables. Rollback transaction</span></span><br><span class="line"><span class="comment">        in all storage engines including binary log and release all</span></span><br><span class="line"><span class="comment">        locks.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      trans_rollback_implicit(thd);</span><br><span class="line">      thd-&gt;mdl_context.release_transactional_locks();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    thd-&gt;cleanup_after_query();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">case</span> COM_QUIT:</span><br><span class="line">    <span class="comment">/* We don't calculate statistics for this command */</span></span><br><span class="line">    general_log_print(thd, command, NullS);</span><br><span class="line">    net-&gt;error=<span class="number">0</span>;				<span class="comment">// Don't give 'abort' message</span></span><br><span class="line">    thd-&gt;get_stmt_da()-&gt;disable_status();       <span class="comment">// Don't send anything back</span></span><br><span class="line">    error=TRUE;					<span class="comment">// End server</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">  <span class="keyword">case</span> COM_BINLOG_DUMP:</span><br><span class="line">    &#123;</span><br><span class="line">      ulong pos;</span><br><span class="line">      ushort flags;</span><br><span class="line">      uint32 slave_server_id;</span><br><span class="line"></span><br><span class="line">      status_var_increment(thd-&gt;status_var.com_other);</span><br><span class="line"></span><br><span class="line">      thd-&gt;enable_slow_log&amp;= opt_log_slow_admin_statements;</span><br><span class="line">      thd-&gt;query_plan_flags|= QPLAN_ADMIN;</span><br><span class="line">      <span class="keyword">if</span> (check_global_access(thd, REPL_SLAVE_ACL))</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* <span class="doctag">TODO:</span> The following has to be changed to an 8 byte integer */</span></span><br><span class="line">      pos = uint4korr(packet);</span><br><span class="line">      flags = uint2korr(packet + <span class="number">4</span>);</span><br><span class="line">      thd-&gt;variables.server_id=<span class="number">0</span>; <span class="comment">/* avoid suicide */</span></span><br><span class="line">      <span class="keyword">if</span> ((slave_server_id= uint4korr(packet+<span class="number">6</span>))) <span class="comment">// mysqlbinlog.server_id==0</span></span><br><span class="line">	kill_zombie_dump_threads(slave_server_id);</span><br><span class="line">      thd-&gt;variables.server_id = slave_server_id;</span><br><span class="line"></span><br><span class="line">      general_log_print(thd, command, <span class="string">"Log: '%s'  Pos: %ld"</span>, packet+<span class="number">10</span>,</span><br><span class="line">                      (<span class="keyword">long</span>) pos);</span><br><span class="line">      mysql_binlog_send(thd, thd-&gt;strdup(packet + <span class="number">10</span>), (<span class="keyword">my_off_t</span>) pos, flags);</span><br><span class="line">      unregister_slave(thd,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">      <span class="comment">/*  fake COM_QUIT -- if we get here, the thread needs to terminate */</span></span><br><span class="line">      error = TRUE;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">case</span> COM_REFRESH:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> not_used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Initialize thd-&gt;lex since it's used in many base functions, such as</span></span><br><span class="line"><span class="comment">      open_tables(). Otherwise, it remains unitialized and may cause crash</span></span><br><span class="line"><span class="comment">      during execution of COM_REFRESH.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    lex_start(thd);</span><br><span class="line">    </span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_FLUSH]);</span><br><span class="line">    ulonglong options= (ulonglong) (uchar) packet[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (trans_commit_implicit(thd))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    thd-&gt;mdl_context.release_transactional_locks();</span><br><span class="line">    <span class="keyword">if</span> (check_global_access(thd,RELOAD_ACL))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    general_log_print(thd, command, NullS);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> DBUG_OFF</span></span><br><span class="line">    <span class="keyword">bool</span> debug_simulate= FALSE;</span><br><span class="line">    DBUG_EXECUTE_IF(<span class="string">"simulate_detached_thread_refresh"</span>, debug_simulate= TRUE;);</span><br><span class="line">    <span class="keyword">if</span> (debug_simulate)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Simulate a reload without a attached thread session.</span></span><br><span class="line"><span class="comment">        Provides a environment similar to that of when the</span></span><br><span class="line"><span class="comment">        server receives a SIGHUP signal and reloads caches</span></span><br><span class="line"><span class="comment">        and flushes tables.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">bool</span> res;</span><br><span class="line">      set_current_thd(<span class="number">0</span>);</span><br><span class="line">      res= reload_acl_and_cache(<span class="literal">NULL</span>, options | REFRESH_FAST,</span><br><span class="line">                                <span class="literal">NULL</span>, &amp;not_used);</span><br><span class="line">      set_current_thd(thd);</span><br><span class="line">      <span class="keyword">if</span> (res)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">    &#123;</span><br><span class="line">      thd-&gt;lex-&gt;relay_log_connection_name= empty_lex_str;</span><br><span class="line">      <span class="keyword">if</span> (reload_acl_and_cache(thd, options, (TABLE_LIST*) <span class="number">0</span>, &amp;not_used))</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (trans_commit_implicit(thd))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    close_thread_tables(thd);</span><br><span class="line">    thd-&gt;mdl_context.release_transactional_locks();</span><br><span class="line">    my_ok(thd);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">  <span class="keyword">case</span> COM_SHUTDOWN:</span><br><span class="line">  &#123;</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_other);</span><br><span class="line">    <span class="keyword">if</span> (check_global_access(thd,SHUTDOWN_ACL))</span><br><span class="line">      <span class="keyword">break</span>; <span class="comment">/* purecov: inspected */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the client is &lt; 4.1.3, it is going to send us no argument; then</span></span><br><span class="line"><span class="comment">      packet_length is 0, packet[0] is the end 0 of the packet. Note that</span></span><br><span class="line"><span class="comment">      SHUTDOWN_DEFAULT is 0. If client is &gt;= 4.1.3, the shutdown level is in</span></span><br><span class="line"><span class="comment">      packet[0].</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">enum</span> mysql_enum_shutdown_level level;</span><br><span class="line">    level= (<span class="keyword">enum</span> mysql_enum_shutdown_level) (uchar) packet[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (level == SHUTDOWN_DEFAULT)</span><br><span class="line">      level= SHUTDOWN_WAIT_ALL_BUFFERS; <span class="comment">// soon default will be configurable</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (level != SHUTDOWN_WAIT_ALL_BUFFERS)</span><br><span class="line">    &#123;</span><br><span class="line">      my_error(ER_NOT_SUPPORTED_YET, MYF(<span class="number">0</span>), <span class="string">"this shutdown level"</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DBUG_PRINT(<span class="string">"quit"</span>,(<span class="string">"Got shutdown command for level %u"</span>, level));</span><br><span class="line">    general_log_print(thd, command, NullS);</span><br><span class="line">    my_eof(thd);</span><br><span class="line">    kill_mysql();</span><br><span class="line">    error=TRUE;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">case</span> COM_STATISTICS:</span><br><span class="line">  &#123;</span><br><span class="line">    STATUS_VAR *current_global_status_var;      <span class="comment">// Big; Don't allocate on stack</span></span><br><span class="line">    ulong uptime;</span><br><span class="line">    uint length __attribute__((unused));</span><br><span class="line">    ulonglong queries_per_second1000;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">250</span>];</span><br><span class="line">    uint buff_len= <span class="keyword">sizeof</span>(buff);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(current_global_status_var= (STATUS_VAR*)</span><br><span class="line">          thd-&gt;alloc(<span class="keyword">sizeof</span>(STATUS_VAR))))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    general_log_print(thd, command, NullS);</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_SHOW_STATUS]);</span><br><span class="line">    calc_sum_of_all_status(current_global_status_var);</span><br><span class="line">    <span class="keyword">if</span> (!(uptime= (ulong) (thd-&gt;start_time - server_start_time)))</span><br><span class="line">      queries_per_second1000= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      queries_per_second1000= thd-&gt;query_id * <span class="number">1000</span> / uptime;</span><br><span class="line"></span><br><span class="line">    length= my_snprintf(buff, buff_len - <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"Uptime: %lu  Threads: %d  Questions: %lu  "</span></span><br><span class="line">                        <span class="string">"Slow queries: %lu  Opens: %lu  Flush tables: %lu  "</span></span><br><span class="line">                        <span class="string">"Open tables: %u  Queries per second avg: %u.%03u"</span>,</span><br><span class="line">                        uptime,</span><br><span class="line">                        (<span class="keyword">int</span>) thread_count, (ulong) thd-&gt;query_id,</span><br><span class="line">                        current_global_status_var-&gt;long_query_count,</span><br><span class="line">                        current_global_status_var-&gt;opened_tables,</span><br><span class="line">                        tdc_refresh_version(),</span><br><span class="line">                        tc_records(),</span><br><span class="line">                        (uint) (queries_per_second1000 / <span class="number">1000</span>),</span><br><span class="line">                        (uint) (queries_per_second1000 % <span class="number">1000</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> EMBEDDED_LIBRARY</span></span><br><span class="line">    <span class="comment">/* Store the buffer in permanent memory */</span></span><br><span class="line">    my_ok(thd, <span class="number">0</span>, <span class="number">0</span>, buff);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    (<span class="keyword">void</span>) my_net_write(net, (uchar*) buff, length);</span><br><span class="line">    (<span class="keyword">void</span>) net_flush(net);</span><br><span class="line">    thd-&gt;get_stmt_da()-&gt;disable_status();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_PING:</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_other);</span><br><span class="line">    my_ok(thd);				<span class="comment">// Tell client we are alive</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COM_PROCESS_INFO:</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_SHOW_PROCESSLIST]);</span><br><span class="line">    <span class="keyword">if</span> (!thd-&gt;security_ctx-&gt;priv_user[<span class="number">0</span>] &amp;&amp;</span><br><span class="line">        check_global_access(thd, PROCESS_ACL))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    general_log_print(thd, command, NullS);</span><br><span class="line">    mysqld_list_processes(thd,</span><br><span class="line">			  thd-&gt;security_ctx-&gt;master_access &amp; PROCESS_ACL ? </span><br><span class="line">			  NullS : thd-&gt;security_ctx-&gt;priv_user, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COM_PROCESS_KILL:</span><br><span class="line">  &#123;</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_KILL]);</span><br><span class="line">    ulong id=(ulong) uint4korr(packet);</span><br><span class="line">    sql_kill(thd, id, KILL_CONNECTION_HARD, KILL_TYPE_ID);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_SET_OPTION:</span><br><span class="line">  &#123;</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_stat[SQLCOM_SET_OPTION]);</span><br><span class="line">    uint opt_command= uint2korr(packet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (opt_command) &#123;</span><br><span class="line">    <span class="keyword">case</span> (<span class="keyword">int</span>) MYSQL_OPTION_MULTI_STATEMENTS_ON:</span><br><span class="line">      thd-&gt;client_capabilities|= CLIENT_MULTI_STATEMENTS;</span><br><span class="line">      my_eof(thd);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> (<span class="keyword">int</span>) MYSQL_OPTION_MULTI_STATEMENTS_OFF:</span><br><span class="line">      thd-&gt;client_capabilities&amp;= ~CLIENT_MULTI_STATEMENTS;</span><br><span class="line">      my_eof(thd);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      my_message(ER_UNKNOWN_COM_ERROR, ER_THD(thd, ER_UNKNOWN_COM_ERROR),</span><br><span class="line">                 MYF(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> COM_DEBUG:</span><br><span class="line">    status_var_increment(thd-&gt;status_var.com_other);</span><br><span class="line">    <span class="keyword">if</span> (check_global_access(thd, SUPER_ACL))</span><br><span class="line">      <span class="keyword">break</span>;					<span class="comment">/* purecov: inspected */</span></span><br><span class="line">    mysql_print_status();</span><br><span class="line">    general_log_print(thd, command, NullS);</span><br><span class="line">    my_eof(thd);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COM_SLEEP:</span><br><span class="line">  <span class="keyword">case</span> COM_CONNECT:				<span class="comment">// Impossible here</span></span><br><span class="line">  <span class="keyword">case</span> COM_TIME:				<span class="comment">// Impossible from client</span></span><br><span class="line">  <span class="keyword">case</span> COM_DELAYED_INSERT:</span><br><span class="line">  <span class="keyword">case</span> COM_END:</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    my_message(ER_UNKNOWN_COM_ERROR, ER_THD(thd, ER_UNKNOWN_COM_ERROR),</span><br><span class="line">               MYF(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_WSREP</span></span><br><span class="line"> dispatch_end:</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (WSREP(thd))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* wsrep BF abort in query exec phase */</span></span><br><span class="line">    mysql_mutex_lock(&amp;thd-&gt;LOCK_wsrep_thd);</span><br><span class="line">    do_end_of_statement= thd-&gt;wsrep_conflict_state != REPLAYING &amp;&amp;</span><br><span class="line">                         thd-&gt;wsrep_conflict_state != RETRY_AUTOCOMMIT;</span><br><span class="line">    mysql_mutex_unlock(&amp;thd-&gt;LOCK_wsrep_thd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    do_end_of_statement= <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_WSREP */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (do_end_of_statement)</span><br><span class="line">  &#123;</span><br><span class="line">    DBUG_ASSERT(thd-&gt;derived_tables == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">               (thd-&gt;open_tables == <span class="literal">NULL</span> ||</span><br><span class="line">               (thd-&gt;locked_tables_mode == LTM_LOCK_TABLES)));</span><br><span class="line"></span><br><span class="line">    thd_proc_info(thd, <span class="string">"updating status"</span>);</span><br><span class="line">    <span class="comment">/* Finalize server status flags after executing a command. */</span></span><br><span class="line">    thd-&gt;update_server_status();</span><br><span class="line">    thd-&gt;protocol-&gt;end_statement();</span><br><span class="line">    query_cache_end_of_result(thd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!thd-&gt;is_error() &amp;&amp; !thd-&gt;killed_errno())</span><br><span class="line">    mysql_audit_general(thd, MYSQL_AUDIT_GENERAL_RESULT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  mysql_audit_general(thd, MYSQL_AUDIT_GENERAL_STATUS,</span><br><span class="line">                      thd-&gt;get_stmt_da()-&gt;is_error() ?</span><br><span class="line">                      thd-&gt;get_stmt_da()-&gt;sql_errno() : <span class="number">0</span>,</span><br><span class="line">                      command_name[command].str);</span><br><span class="line"></span><br><span class="line">  thd-&gt;update_all_stats();</span><br><span class="line"></span><br><span class="line">  log_slow_statement(thd);</span><br><span class="line"></span><br><span class="line">  THD_STAGE_INFO(thd, stage_cleaning_up);</span><br><span class="line">  thd-&gt;reset_query();</span><br><span class="line">  thd-&gt;set_examined_row_count(<span class="number">0</span>);                   <span class="comment">// For processlist</span></span><br><span class="line">  thd-&gt;set_command(COM_SLEEP);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Performance Schema Interface instrumentation, end */</span></span><br><span class="line">  MYSQL_END_STATEMENT(thd-&gt;m_statement_psi, thd-&gt;get_stmt_da());</span><br><span class="line">  thd-&gt;m_statement_psi= <span class="literal">NULL</span>;</span><br><span class="line">  thd-&gt;m_digest= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  dec_thread_running();</span><br><span class="line">  thd-&gt;packet.shrink(thd-&gt;variables.net_buffer_length);	<span class="comment">// Reclaim some memory</span></span><br><span class="line">  free_root(thd-&gt;mem_root,MYF(MY_KEEP_PREALLOC));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ENABLED_PROFILING)</span></span><br><span class="line">  thd-&gt;profiling.finish_current_query();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (MYSQL_QUERY_DONE_ENABLED() || MYSQL_COMMAND_DONE_ENABLED())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> res __attribute__((unused));</span><br><span class="line">    res= (<span class="keyword">int</span>) thd-&gt;is_error();</span><br><span class="line">    <span class="keyword">if</span> (command == COM_QUERY)</span><br><span class="line">    &#123;</span><br><span class="line">      MYSQL_QUERY_DONE(res);</span><br><span class="line">    &#125;</span><br><span class="line">    MYSQL_COMMAND_DONE(res);</span><br><span class="line">  &#125;</span><br><span class="line">  DEBUG_SYNC(thd,<span class="string">"dispatch_command_end"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check that some variables are reset properly */</span></span><br><span class="line">  DBUG_ASSERT(thd-&gt;abort_on_warning == <span class="number">0</span>);</span><br><span class="line">  thd-&gt;lex-&gt;restore_set_statement_var();</span><br><span class="line">  DBUG_RETURN(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面查询语句的时候，在mysql_parse函数之前做了检查。</p>
<p>未完待续</p>

      </div>
      
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-03-27T03:34:48+00:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>更新于 2020年3月27日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/galera/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>galera</p></a></div>


        
      
        
          

        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                          <h4>
                              <a href="/2020/03/31/runc%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" rel="prev" title="runc原理学习">
                                
                                    runc原理学习
                                
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/runc/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> runc</a>
                              </h6>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2020/03/02/kubernetes_debug%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="prev" title="kubernetes debug环境搭建">
                                  
                                      kubernetes debug环境搭建
                                  
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/k8s/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> k8s</a>
                              </h6>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'galera原理和源码学习',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content material'>
    
      <div class='avatar'>
        <img class='avatar' src='/images/avatar.jpg'/>
      </div>
    
    
      <div class='text'>
        
        
        
          <p><span id="jinrishici-sentence">Saar's Blog</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/fu4ck"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='material'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content material'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#galera原理和源码学习"><span class="toc-text">galera原理和源码学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码架构"><span class="toc-text">源码架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源码执行流程"><span class="toc-text">源码执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一致性协议"><span class="toc-text">一致性协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#galera代码入口"><span class="toc-text">galera代码入口</span></a></li></ol></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              <section class='widget grid'>
  
<header class='material'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content material'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/categories/" href="/categories/"
          
            rel="nofollow"
          
          
          id="categories">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
    </ul>
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='material'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/categories/"
    title="/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/ElasticSearch/" href="/categories/ElasticSearch/"><div class='name'>ElasticSearch</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/ctf/" href="/categories/ctf/"><div class='name'>ctf</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/docker/" href="/categories/docker/"><div class='name'>docker</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/"><div class='name'>golang</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/influxdb/" href="/categories/influxdb/"><div class='name'>influxdb</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/k8s/" href="/categories/k8s/"><div class='name'>k8s</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/malloc/" href="/categories/malloc/"><div class='name'>malloc</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/monitor/" href="/categories/monitor/"><div class='name'>monitor</div><div class='badge'>(10)</div></a></li>
        
          <li><a class="flat-box" title="/categories/mysql/" href="/categories/mysql/"><div class='name'>mysql</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/prometheus/" href="/categories/prometheus/"><div class='name'>prometheus</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/pwn/" href="/categories/pwn/"><div class='name'>pwn</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/rabbitmq/" href="/categories/rabbitmq/"><div class='name'>rabbitmq</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/redis/" href="/categories/redis/"><div class='name'>redis</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/tsdb/" href="/categories/tsdb/"><div class='name'>tsdb</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"><div class='name'>分布式</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%AD%98%E5%82%A8/" href="/categories/%E5%AD%98%E5%82%A8/"><div class='name'>存储</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%BF%83%E7%81%B5%E9%B8%A1%E6%B1%A4/" href="/categories/%E5%BF%83%E7%81%B5%E9%B8%A1%E6%B1%A4/"><div class='name'>心灵鸡汤</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><div class='name'>深度学习</div><div class='badge'>(2)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='material'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/tags/"
    title="/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <a href="/tags/ElasticSearch/" style="font-size: 17.33px; color: #828282">ElasticSearch</a> <a href="/tags/ctf/" style="font-size: 14px; color: #999">ctf</a> <a href="/tags/galera/" style="font-size: 14px; color: #999">galera</a> <a href="/tags/golang/" style="font-size: 17.33px; color: #828282">golang</a> <a href="/tags/influxdb/" style="font-size: 17.33px; color: #828282">influxdb</a> <a href="/tags/k8s/" style="font-size: 20.67px; color: #6c6c6c">k8s</a> <a href="/tags/malloc/" style="font-size: 17.33px; color: #828282">malloc</a> <a href="/tags/monitor/" style="font-size: 24px; color: #555">monitor</a> <a href="/tags/mysql/" style="font-size: 14px; color: #999">mysql</a> <a href="/tags/pwn/" style="font-size: 14px; color: #999">pwn</a> <a href="/tags/rabbitmq/" style="font-size: 17.33px; color: #828282">rabbitmq</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/runc/" style="font-size: 14px; color: #999">runc</a> <a href="/tags/tsdb/" style="font-size: 14px; color: #999">tsdb</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 17.33px; color: #828282">分布式</a> <a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 14px; color: #999">存储</a> <a href="/tags/%E5%BF%83%E7%81%B5%E9%B8%A1%E6%B1%A4/" style="font-size: 14px; color: #999">心灵鸡汤</a> <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 17.33px; color: #828282">深度学习</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/fu4ck"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('') {
          $('').backstretch(
          ["https://img.xjh.me/desktop/bg/nature/65253358_p0.jpg", "http://img.xjh.me/desktop/bg/nature/56245464_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63606459_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63190697_p0.jpg", "http://img.xjh.me/desktop/bg/nature/59322814_p0.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.xjh.me/desktop/bg/nature/65253358_p0.jpg", "http://img.xjh.me/desktop/bg/nature/56245464_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63606459_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63190697_p0.jpg", "http://img.xjh.me/desktop/bg/nature/59322814_p0.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
