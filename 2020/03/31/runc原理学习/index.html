<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>runc原理学习 | Saar&#39;s Blog</title>
  
  

  
  <link rel="alternate" href="/atom.xml" title="Saar's Blog">
  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  <!--自定义看板娘-->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="/live2d-widget/autoload.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>

  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Saar's Blog" type="application/atom+xml">
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Saar's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header material">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="material"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Saar's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;首页
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/03/31/runc%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/">
        runc原理学习
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://www.yorzorzy.xyz" rel="nofollow">
        
          <i class="fas fa-user" aria-hidden="true"></i>
        
        <p>Saar</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2020-03-31</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/docker/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>docker</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            
  

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h2 id="runc原理学习"><a href="#runc原理学习" class="headerlink" title="runc原理学习"></a>runc原理学习</h2><h3 id="1-代码结构"><a href="#1-代码结构" class="headerlink" title="1. 代码结构"></a>1. 代码结构</h3><p><img src="https://img-blog.csdnimg.cn/20190302170732673.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW5tbzE4N0ozWDE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="2-原理分析"><a href="#2-原理分析" class="headerlink" title="2. 原理分析"></a>2. 原理分析</h3><p>从create -&gt; start -&gt; run-&gt; stop来分析：</p>
<p><img src="http://www.sel.zju.edu.cn/wp-content/uploads/2018/08/runc.png" alt="runc"></p>
<p>createCommand代码入口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		spec, err := setupSpec(context)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		status, err := startContainer(context, spec, <span class="literal">true</span>)  <span class="comment">// 开启容器</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// exit with the container's exit status so any external supervisor is</span></span><br><span class="line">		<span class="comment">// notified of the exit with the correct exit status.</span></span><br><span class="line">		os.Exit(status)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<p>startContainter:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startContainer</span><span class="params">(context *cli.Context, spec *specs.Spec, create <span class="keyword">bool</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	id := context.Args().First()</span><br><span class="line">	<span class="keyword">if</span> id == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, errEmptyID</span><br><span class="line">	&#125;</span><br><span class="line">	container, err := createContainer(context, id, spec)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	detach := context.Bool(<span class="string">"detach"</span>)</span><br><span class="line">	<span class="comment">// Support on-demand socket activation by passing file descriptors into the container init process.</span></span><br><span class="line">	listenFDs := []*os.File&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> os.Getenv(<span class="string">"LISTEN_FDS"</span>) != <span class="string">""</span> &#123;</span><br><span class="line">		listenFDs = activation.Files(<span class="literal">false</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	r := &amp;runner&#123;</span><br><span class="line">		enableSubreaper: !context.Bool(<span class="string">"no-subreaper"</span>),</span><br><span class="line">		shouldDestroy:   <span class="literal">true</span>,</span><br><span class="line">		container:       container,</span><br><span class="line">		listenFDs:       listenFDs,</span><br><span class="line">		console:         context.String(<span class="string">"console"</span>),</span><br><span class="line">		detach:          detach,</span><br><span class="line">		pidFile:         context.String(<span class="string">"pid-file"</span>),</span><br><span class="line">		create:          create,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r.run(&amp;spec.Process)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用函数createContainer，然后返回初始化之后的runner结构体。</p>
<p>createContainer函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(context *cli.Context, id <span class="keyword">string</span>, spec *specs.Spec)</span> <span class="params">(libcontainer.Container, error)</span></span> &#123;</span><br><span class="line">	config, err := specconv.CreateLibcontainerConfig(&amp;specconv.CreateOpts&#123;</span><br><span class="line">		CgroupName:       id,</span><br><span class="line">		UseSystemdCgroup: context.GlobalBool(<span class="string">"systemd-cgroup"</span>),</span><br><span class="line">		NoPivotRoot:      context.Bool(<span class="string">"no-pivot"</span>),</span><br><span class="line">		NoNewKeyring:     context.Bool(<span class="string">"no-new-keyring"</span>),</span><br><span class="line">		Spec:             spec,</span><br><span class="line">	&#125;)</span><br><span class="line">    <span class="comment">//读取配置文件</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 查看rootfs的状态</span></span><br><span class="line">	<span class="keyword">if</span> _, err := os.Stat(config.Rootfs); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"rootfs (%q) does not exist"</span>, config.Rootfs)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//加载factory</span></span><br><span class="line">	factory, err := loadFactory(context)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//创建factory</span></span><br><span class="line">	<span class="keyword">return</span> factory.Create(id, config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadFactory(context)函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loadFactory returns the configured factory instance for execing containers.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadFactory</span><span class="params">(context *cli.Context)</span> <span class="params">(libcontainer.Factory, error)</span></span> &#123;</span><br><span class="line">	root := context.GlobalString(<span class="string">"root"</span>)</span><br><span class="line">	abs, err := filepath.Abs(root)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	cgroupManager := libcontainer.Cgroupfs  <span class="comment">// 获取cgroupfs对象</span></span><br><span class="line">	<span class="keyword">if</span> context.GlobalBool(<span class="string">"systemd-cgroup"</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> systemd.UseSystemd() &#123;</span><br><span class="line">			cgroupManager = libcontainer.SystemdCgroups</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"systemd cgroup flag passed, but systemd support for managing cgroups is not available"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> libcontainer.New(abs, cgroupManager, libcontainer.CriuPath(context.GlobalString(<span class="string">"criu"</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>New函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New returns a linux based container factory based in the root directory and</span></span><br><span class="line"><span class="comment">// configures the factory with the provided option funcs.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(root <span class="keyword">string</span>, options ...<span class="keyword">func</span>(*LinuxFactory)</span> <span class="title">error</span>) <span class="params">(Factory, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> root != <span class="string">""</span> &#123;</span><br><span class="line">        <span class="comment">//设置权限</span></span><br><span class="line">		<span class="keyword">if</span> err := os.MkdirAll(root, <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//返回一个自身进程</span></span><br><span class="line">	l := &amp;LinuxFactory&#123;</span><br><span class="line">		Root:      root,</span><br><span class="line">		InitArgs:  []<span class="keyword">string</span>&#123;<span class="string">"/proc/self/exe"</span>, <span class="string">"init"</span>&#125;,</span><br><span class="line">		Validator: validate.New(),</span><br><span class="line">		CriuPath:  <span class="string">"criu"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	Cgroupfs(l)</span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> options &#123;</span><br><span class="line">		<span class="keyword">if</span> err := opt(l); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> l, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Cgroupfs函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cgroupfs is an options func to configure a LinuxFactory to return</span></span><br><span class="line"><span class="comment">// containers that use the native cgroups filesystem implementation to</span></span><br><span class="line"><span class="comment">// create and manage cgroups.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cgroupfs</span><span class="params">(l *LinuxFactory)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">//返回一个cgroups对象</span></span><br><span class="line">	l.NewCgroupsManager = <span class="function"><span class="keyword">func</span><span class="params">(config *configs.Cgroup, paths <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">cgroups</span>.<span class="title">Manager</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;fs.Manager&#123;</span><br><span class="line">			Cgroups: config,</span><br><span class="line">			Paths:   paths,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>create函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LinuxFactory)</span> <span class="title">Create</span><span class="params">(id <span class="keyword">string</span>, config *configs.Config)</span> <span class="params">(Container, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// root为空返回</span></span><br><span class="line">   <span class="keyword">if</span> l.Root == <span class="string">""</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(fmt.Errorf(<span class="string">"invalid root"</span>), ConfigInvalid)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">// 验证id</span></span><br><span class="line">   <span class="keyword">if</span> err := l.validateID(id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//验证是否路径正常</span></span><br><span class="line">   <span class="keyword">if</span> err := l.Validator.Validate(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, ConfigInvalid)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//获取host uid</span></span><br><span class="line">   uid, err := config.HostUID()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">// 获取gid</span></span><br><span class="line">   gid, err := config.HostGID()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//容器的路径</span></span><br><span class="line">   containerRoot := filepath.Join(l.Root, id)</span><br><span class="line">    <span class="comment">//如果已经在使用，报错</span></span><br><span class="line">   <span class="keyword">if</span> _, err := os.Stat(containerRoot); err == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(fmt.Errorf(<span class="string">"container with id exists: %v"</span>, id), IdInUse)</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> !os.IsNotExist(err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//设置权限</span></span><br><span class="line">   <span class="keyword">if</span> err := os.MkdirAll(containerRoot, <span class="number">0711</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//赋权</span></span><br><span class="line">   <span class="keyword">if</span> err := os.Chown(containerRoot, uid, gid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//fifo路径</span></span><br><span class="line">   fifoName := filepath.Join(containerRoot, execFifoFilename)</span><br><span class="line">   oldMask := syscall.Umask(<span class="number">0000</span>)</span><br><span class="line">   <span class="keyword">if</span> err := syscall.Mkfifo(fifoName, <span class="number">0622</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      syscall.Umask(oldMask)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//umask</span></span><br><span class="line">   syscall.Umask(oldMask)</span><br><span class="line">   <span class="keyword">if</span> err := os.Chown(fifoName, uid, gid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//返回容器对象</span></span><br><span class="line">   c := &amp;linuxContainer&#123;</span><br><span class="line">      id:            id,</span><br><span class="line">      root:          containerRoot,</span><br><span class="line">      config:        config,</span><br><span class="line">      initArgs:      l.InitArgs,</span><br><span class="line">      criuPath:      l.CriuPath,</span><br><span class="line">      cgroupManager: l.NewCgroupsManager(config.Cgroups, <span class="literal">nil</span>),</span><br><span class="line">   &#125;</span><br><span class="line">   c.state = &amp;stoppedState&#123;c: c&#125;</span><br><span class="line">   <span class="keyword">return</span> c, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>run函数执行启动：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *runner)</span> <span class="title">run</span><span class="params">(config *specs.Process)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	process, err := newProcess(*config)  <span class="comment">//创建新的process,返回一个新的libcontainer process</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.destroy()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.listenFDs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		process.Env = <span class="built_in">append</span>(process.Env, fmt.Sprintf(<span class="string">"LISTEN_FDS=%d"</span>, <span class="built_in">len</span>(r.listenFDs)), <span class="string">"LISTEN_PID=1"</span>)</span><br><span class="line">		process.ExtraFiles = <span class="built_in">append</span>(process.ExtraFiles, r.listenFDs...)</span><br><span class="line">	&#125;</span><br><span class="line">	rootuid, err := r.container.Config().HostUID()  <span class="comment">//获取host uid</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.destroy()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	rootgid, err := r.container.Config().HostGID()  <span class="comment">//获取host gid</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.destroy()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	tty, err := setupIO(process, rootuid, rootgid, r.console, config.Terminal, r.detach || r.create)  <span class="comment">// 设置io</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.destroy()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	handler := newSignalHandler(tty, r.enableSubreaper) <span class="comment">// 信号处理函数</span></span><br><span class="line">	startFn := r.container.Start  <span class="comment">//启动函数</span></span><br><span class="line">	<span class="keyword">if</span> !r.create &#123;</span><br><span class="line">		startFn = r.container.Run</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> tty.Close()</span><br><span class="line">	<span class="keyword">if</span> err := startFn(process); err != <span class="literal">nil</span> &#123; <span class="comment">//启动进程</span></span><br><span class="line">		r.destroy()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tty.ClosePostStart(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.terminate(process)</span><br><span class="line">		r.destroy()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> r.pidFile != <span class="string">""</span> &#123;  <span class="comment">//创建pid文件</span></span><br><span class="line">		<span class="keyword">if</span> err := createPidFile(r.pidFile, process); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			r.terminate(process)</span><br><span class="line">			r.destroy()</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> r.detach || r.create &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	status, err := handler.forward(process) <span class="comment">//等待信息</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.terminate(process)</span><br><span class="line">	&#125;</span><br><span class="line">	r.destroy()</span><br><span class="line">	<span class="keyword">return</span> status, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这边启动函数为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">Start</span><span class="params">(process *Process)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   c.m.Lock()</span><br><span class="line">   <span class="keyword">defer</span> c.m.Unlock()</span><br><span class="line">   status, err := c.currentStatus() <span class="comment">//获取当前状态</span></span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> c.start(process, status == Stopped)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>start函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">start</span><span class="params">(process *Process, isInit <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	parent, err := c.newParentProcess(process, isInit) <span class="comment">//创建newParentProcess进程，</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"creating new parent process"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := parent.start(); err != <span class="literal">nil</span> &#123; <span class="comment">//start</span></span><br><span class="line">		<span class="comment">// terminate the process to ensure that it properly is reaped.</span></span><br><span class="line">		<span class="keyword">if</span> err := parent.terminate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logrus.Warn(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"starting container process"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// generate a timestamp indicating when the container was started</span></span><br><span class="line">	c.created = time.Now().UTC()</span><br><span class="line">	c.state = &amp;runningState&#123;</span><br><span class="line">		c: c,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> isInit &#123;</span><br><span class="line">		c.state = &amp;createdState&#123;</span><br><span class="line">			c: c,</span><br><span class="line">		&#125;</span><br><span class="line">		state, err := c.updateState(parent)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		c.initProcessStartTime = state.InitProcessStartTime</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> c.config.Hooks != <span class="literal">nil</span> &#123;</span><br><span class="line">			s := configs.HookState&#123;</span><br><span class="line">				Version:    c.config.Version,</span><br><span class="line">				ID:         c.id,</span><br><span class="line">				Pid:        parent.pid(),</span><br><span class="line">				Root:       c.config.Rootfs,</span><br><span class="line">				BundlePath: utils.SearchLabels(c.config.Labels, <span class="string">"bundle"</span>),</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//启动hook函数</span></span><br><span class="line">			<span class="keyword">for</span> i, hook := <span class="keyword">range</span> c.config.Hooks.Poststart &#123;</span><br><span class="line">				<span class="keyword">if</span> err := hook.Run(s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> err := parent.terminate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">						logrus.Warn(err)</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"running poststart hook %d"</span>, i)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>newParentProcess函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">newParentProcess</span><span class="params">(p *Process, doInit <span class="keyword">bool</span>)</span> <span class="params">(parentProcess, error)</span></span> &#123;</span><br><span class="line">	parentPipe, childPipe, err := newPipe()<span class="comment">//新建管道</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newSystemErrorWithCause(err, <span class="string">"creating new init pipe"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	rootDir, err := os.Open(c.root) <span class="comment">//打开rootdir路径</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	cmd, err := c.commandTemplate(p, childPipe, rootDir)<span class="comment">//返回template模版</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newSystemErrorWithCause(err, <span class="string">"creating new command template"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !doInit &#123;</span><br><span class="line">        <span class="comment">//new set namespace process</span></span><br><span class="line">		<span class="keyword">return</span> c.newSetnsProcess(p, cmd, parentPipe, childPipe, rootDir)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//new init process</span></span><br><span class="line">	<span class="keyword">return</span> c.newInitProcess(p, cmd, parentPipe, childPipe, rootDir)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>newSetnsProcess函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">newSetnsProcess</span><span class="params">(p *Process, cmd *exec.Cmd, parentPipe, childPipe, rootDir *os.File)</span> <span class="params">(*setnsProcess, error)</span></span> &#123;</span><br><span class="line">	cmd.Env = <span class="built_in">append</span>(cmd.Env, <span class="string">"_LIBCONTAINER_INITTYPE="</span>+<span class="keyword">string</span>(initSetns))</span><br><span class="line">	state, err := c.currentState()<span class="comment">//获取当前状态</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newSystemErrorWithCause(err, <span class="string">"getting container's current state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// for setns process, we dont have to set cloneflags as the process namespaces</span></span><br><span class="line">	<span class="comment">// will only be set via setns syscall</span></span><br><span class="line">    <span class="comment">// bootstrapData</span></span><br><span class="line">	data, err := c.bootstrapData(<span class="number">0</span>, state.NamespacePaths, p.consolePath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> set on container for process management</span></span><br><span class="line">	<span class="keyword">return</span> &amp;setnsProcess&#123;</span><br><span class="line">		cmd:           cmd,</span><br><span class="line">		cgroupPaths:   c.cgroupManager.GetPaths(),</span><br><span class="line">		childPipe:     childPipe,</span><br><span class="line">		parentPipe:    parentPipe,</span><br><span class="line">		config:        c.newInitConfig(p),</span><br><span class="line">		process:       p,</span><br><span class="line">		bootstrapData: data,</span><br><span class="line">		rootDir:       rootDir,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>newInitProcess函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">newInitProcess</span><span class="params">(p *Process, cmd *exec.Cmd, parentPipe, childPipe, rootDir *os.File)</span> <span class="params">(*initProcess, error)</span></span> &#123;</span><br><span class="line">	cmd.Env = <span class="built_in">append</span>(cmd.Env, <span class="string">"_LIBCONTAINER_INITTYPE="</span>+<span class="keyword">string</span>(initStandard))</span><br><span class="line">	nsMaps := <span class="built_in">make</span>(<span class="keyword">map</span>[configs.NamespaceType]<span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">for</span> _, ns := <span class="keyword">range</span> c.config.Namespaces &#123;</span><br><span class="line">		<span class="keyword">if</span> ns.Path != <span class="string">""</span> &#123;</span><br><span class="line">			nsMaps[ns.Type] = ns.Path  <span class="comment">//namespace映射关系</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	_, sharePidns := nsMaps[configs.NEWPID]</span><br><span class="line">	data, err := c.bootstrapData(c.config.Namespaces.CloneFlags(), nsMaps, <span class="string">""</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;initProcess&#123;</span><br><span class="line">		cmd:           cmd,</span><br><span class="line">		childPipe:     childPipe,</span><br><span class="line">		parentPipe:    parentPipe,</span><br><span class="line">		manager:       c.cgroupManager,</span><br><span class="line">		config:        c.newInitConfig(p),</span><br><span class="line">		container:     c,</span><br><span class="line">		process:       p,</span><br><span class="line">		bootstrapData: data,</span><br><span class="line">		sharePidns:    sharePidns,</span><br><span class="line">		rootDir:       rootDir,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>Start命令过程：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		container, err := getContainer(context) <span class="comment">//</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		status, err := container.Status() <span class="comment">//获取容器状态</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> status &#123;</span><br><span class="line">		<span class="keyword">case</span> libcontainer.Created:  <span class="comment">//状态时已经创建，则执行启动</span></span><br><span class="line">			<span class="keyword">return</span> container.Exec()</span><br><span class="line">		<span class="keyword">case</span> libcontainer.Stopped:   <span class="comment">// 已经停止，这个停止时进程已经没有了。docker stop是pause状态。</span></span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start a container that has run and stopped"</span>)</span><br><span class="line">		<span class="keyword">case</span> libcontainer.Running:  <span class="comment">// 已经启动</span></span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start an already running container"</span>)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start a container in the %s state"</span>, status)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<p>getContainer函数，获取容器实例对象</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getContainer returns the specified container instance by loading it from state</span></span><br><span class="line"><span class="comment">// with the default factory.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getContainer</span><span class="params">(context *cli.Context)</span> <span class="params">(libcontainer.Container, error)</span></span> &#123;</span><br><span class="line">	id := context.Args().First()</span><br><span class="line">	<span class="keyword">if</span> id == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errEmptyID</span><br><span class="line">	&#125;</span><br><span class="line">	factory, err := loadFactory(context)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> factory.Load(id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exec执行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">Exec</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	c.m.Lock()</span><br><span class="line">	<span class="keyword">defer</span> c.m.Unlock()</span><br><span class="line">	<span class="keyword">return</span> c.exec() <span class="comment">//调用exec函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">exec</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">//打开path路径</span></span><br><span class="line">	path := filepath.Join(c.root, execFifoFilename)</span><br><span class="line">    <span class="comment">//打开fifo文件</span></span><br><span class="line">	f, err := os.OpenFile(path, os.O_RDONLY, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"open exec fifo for reading"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line">    <span class="comment">//读取文件数据</span></span><br><span class="line">	data, err := ioutil.ReadAll(f)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		os.Remove(path)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start an already running container"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Run命令启动：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		spec, err := setupSpec(context)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		status, err := startContainer(context, spec, <span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// exit with the container's exit status so any external supervisor is</span></span><br><span class="line">			<span class="comment">// notified of the exit with the correct exit status.</span></span><br><span class="line">			os.Exit(status)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<p>调用setupSpec函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setupSpec performs inital setup based on the cli.Context for the container</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupSpec</span><span class="params">(context *cli.Context)</span> <span class="params">(*specs.Spec, error)</span></span> &#123;</span><br><span class="line">	bundle := context.String(<span class="string">"bundle"</span>)</span><br><span class="line">	<span class="keyword">if</span> bundle != <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := os.Chdir(bundle); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	spec, err := loadSpec(specConfig) <span class="comment">//加载spec文件</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	notifySocket := os.Getenv(<span class="string">"NOTIFY_SOCKET"</span>)</span><br><span class="line">	<span class="keyword">if</span> notifySocket != <span class="string">""</span> &#123;</span><br><span class="line">		setupSdNotify(spec, notifySocket)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> os.Geteuid() != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"runc should be run as root"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> spec, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>startContainer函数执行过程和create类似。</p>
<p>delete命令：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !context.Args().Present() &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"runc: \"delete\" requires a minimum of 1 argument"</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		factory, err := loadFactory(context)  <span class="comment">//加载</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, id := <span class="keyword">range</span> context.Args() &#123;</span><br><span class="line">			container, err := factory.Load(id)  <span class="comment">//加载指定的id的容器</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> lerr, ok := err.(libcontainer.Error); ok &amp;&amp; lerr.Code() == libcontainer.ContainerNotExists &#123;</span><br><span class="line">					<span class="comment">// if there was an aborted start or something of the sort then the container's directory could exist but</span></span><br><span class="line">					<span class="comment">// libcontainer does not see it because the state.json file inside that directory was never created.</span></span><br><span class="line">					path := filepath.Join(context.GlobalString(<span class="string">"root"</span>), id)</span><br><span class="line">					<span class="keyword">if</span> err := os.RemoveAll(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">						fmt.Fprintf(os.Stderr, <span class="string">"remove %s: %v\n"</span>, path, err)</span><br><span class="line">					&#125;</span><br><span class="line">					fmt.Fprintf(os.Stderr, <span class="string">"container %s is not exist\n"</span>, id)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			s, err := container.Status() <span class="comment">//获取容器状态</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Fprintf(os.Stderr, <span class="string">"status for %s: %v\n"</span>, id, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">switch</span> s &#123;</span><br><span class="line">			<span class="keyword">case</span> libcontainer.Stopped:  <span class="comment">//已经停止，就销毁</span></span><br><span class="line">				destroy(container)</span><br><span class="line">			<span class="keyword">case</span> libcontainer.Created: <span class="comment">//创建，删掉</span></span><br><span class="line">				err := killContainer(container)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Fprintf(os.Stderr, <span class="string">"kill container %s: %v\n"</span>, id, err)</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">if</span> context.Bool(<span class="string">"force"</span>) &#123;</span><br><span class="line">					err := killContainer(container)</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						fmt.Fprintf(os.Stderr, <span class="string">"kill container %s: %v\n"</span>, id, err)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					fmt.Fprintf(os.Stderr, <span class="string">"cannot delete container %s that is not stopped: %s\n"</span>, id, s)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<p>killcontainer函数，发送信号，销毁进程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">killContainer</span><span class="params">(container libcontainer.Container)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	container.Signal(syscall.SIGKILL)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">		time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">		<span class="keyword">if</span> err := container.Signal(syscall.Signal(<span class="number">0</span>)); err != <span class="literal">nil</span> &#123; <span class="comment">//如果发送信息失败，强制销毁</span></span><br><span class="line">			destroy(container)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"container init still running"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>destroy函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">destroy</span><span class="params">(c *linuxContainer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !c.config.Namespaces.Contains(configs.NEWPID) &#123; <span class="comment">//配置pid</span></span><br><span class="line">		<span class="keyword">if</span> err := killCgroupProcesses(c.cgroupManager); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logrus.Warn(err) <span class="comment">//杀死cgroup进程</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	err := c.cgroupManager.Destroy()  <span class="comment">//销毁cgroupManager</span></span><br><span class="line">	<span class="keyword">if</span> rerr := os.RemoveAll(c.root); err == <span class="literal">nil</span> &#123;  <span class="comment">//删除路径信息</span></span><br><span class="line">		err = rerr</span><br><span class="line">	&#125;</span><br><span class="line">	c.initProcess = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">if</span> herr := runPoststopHooks(c); err == <span class="literal">nil</span> &#123;  <span class="comment">//runPostStopHook</span></span><br><span class="line">		err = herr</span><br><span class="line">	&#125;</span><br><span class="line">	c.state = &amp;stoppedState&#123;c: c&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>initCommand命令调用初始化函数:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> initCommand = cli.Command&#123;</span><br><span class="line">	Name:  <span class="string">"init"</span>,</span><br><span class="line">	Usage: <span class="string">`initialize the namespaces and launch the process (do not call it outside of runc)`</span>,</span><br><span class="line">	Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		factory, _ := libcontainer.New(<span class="string">""</span>)</span><br><span class="line">		<span class="keyword">if</span> err := factory.StartInitialization(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// as the error is sent back to the parent there is no need to log</span></span><br><span class="line">			<span class="comment">// or write it to stderr because the parent process will handle this</span></span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"libcontainer: container init failed to exec"</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StartInitialization loads a container by opening the pipe fd from the parent to read the configuration and state</span></span><br><span class="line"><span class="comment">// This is a low level implementation detail of the reexec and should not be consumed externally</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LinuxFactory)</span> <span class="title">StartInitialization</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> pipefd, rootfd <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> _, pair := <span class="keyword">range</span> []<span class="keyword">struct</span> &#123;</span><br><span class="line">		k <span class="keyword">string</span></span><br><span class="line">		v *<span class="keyword">int</span></span><br><span class="line">	&#125;&#123;</span><br><span class="line">		&#123;<span class="string">"_LIBCONTAINER_INITPIPE"</span>, &amp;pipefd&#125;,</span><br><span class="line">		&#123;<span class="string">"_LIBCONTAINER_STATEDIR"</span>, &amp;rootfd&#125;,</span><br><span class="line">	&#125; &#123;</span><br><span class="line"></span><br><span class="line">		s := os.Getenv(pair.k)</span><br><span class="line"></span><br><span class="line">		i, err := strconv.Atoi(s)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"unable to convert %s=%s to int"</span>, pair.k, s)</span><br><span class="line">		&#125;</span><br><span class="line">		*pair.v = i</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		pipe = os.NewFile(<span class="keyword">uintptr</span>(pipefd), <span class="string">"pipe"</span>)</span><br><span class="line">		it   = initType(os.Getenv(<span class="string">"_LIBCONTAINER_INITTYPE"</span>))</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// clear the current process's environment to clean any libcontainer</span></span><br><span class="line">	<span class="comment">// specific env vars.</span></span><br><span class="line">	os.Clearenv()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> i initer</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// We have an error during the initialization of the container's init,</span></span><br><span class="line">		<span class="comment">// send it back to the parent process in the form of an initError.</span></span><br><span class="line">		<span class="comment">// If container's init successed, syscall.Exec will not return, hence</span></span><br><span class="line">		<span class="comment">// this defer function will never be called.</span></span><br><span class="line">		<span class="keyword">if</span> _, ok := i.(*linuxStandardInit); ok &#123;</span><br><span class="line">			<span class="comment">//  Synchronisation only necessary for standard init.</span></span><br><span class="line">			<span class="keyword">if</span> werr := utils.WriteJSON(pipe, syncT&#123;procError&#125;); werr != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="built_in">panic</span>(err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> werr := utils.WriteJSON(pipe, newSystemError(err)); werr != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ensure that this pipe is always closed</span></span><br><span class="line">		pipe.Close()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> e := <span class="built_in">recover</span>(); e != <span class="literal">nil</span> &#123;</span><br><span class="line">			err = fmt.Errorf(<span class="string">"panic from initialization: %v, %v"</span>, e, <span class="keyword">string</span>(debug.Stack()))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	i, err = newContainerInit(it, pipe, rootfd) </span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> i.Init()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>newContainerInit函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newContainerInit</span><span class="params">(t initType, pipe *os.File, stateDirFD <span class="keyword">int</span>)</span> <span class="params">(initer, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> config *initConfig</span><br><span class="line">	<span class="keyword">if</span> err := json.NewDecoder(pipe).Decode(&amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := populateProcessEnvironment(config.Env); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> t &#123;</span><br><span class="line">	<span class="keyword">case</span> initSetns:</span><br><span class="line">		<span class="keyword">return</span> &amp;linuxSetnsInit&#123;</span><br><span class="line">			config: config,</span><br><span class="line">		&#125;, <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">case</span> initStandard:</span><br><span class="line">		<span class="keyword">return</span> &amp;linuxStandardInit&#123;</span><br><span class="line">			pipe:       pipe,</span><br><span class="line">			parentPid:  syscall.Getppid(),</span><br><span class="line">			config:     config,</span><br><span class="line">			stateDirFD: stateDirFD,</span><br><span class="line">		&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unknown init type %q"</span>, t)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>populateProcessEnvironment函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// populateProcessEnvironment loads the provided environment variables into the</span></span><br><span class="line"><span class="comment">// current processes's environment.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">populateProcessEnvironment</span><span class="params">(env []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, pair := <span class="keyword">range</span> env &#123;</span><br><span class="line">		p := strings.SplitN(pair, <span class="string">"="</span>, <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(p) &lt; <span class="number">2</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid environment '%v'"</span>, pair)</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//设置环境变量</span></span><br><span class="line">		<span class="keyword">if</span> err := os.Setenv(p[<span class="number">0</span>], p[<span class="number">1</span>]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化函数init:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *linuxStandardInit)</span> <span class="title">Init</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !l.config.Config.NoNewKeyring &#123;</span><br><span class="line">		ringname, keepperms, newperms := l.getSessionRingParams()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// do not inherit the parent's session keyring</span></span><br><span class="line">		sessKeyId, err := keys.JoinSessionKeyring(ringname)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// make session keyring searcheable</span></span><br><span class="line">		<span class="keyword">if</span> err := keys.ModKeyringPerm(sessKeyId, keepperms, newperms); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> console *linuxConsole</span><br><span class="line">	<span class="keyword">if</span> l.config.Console != <span class="string">""</span> &#123;</span><br><span class="line">		console = newConsoleFromPath(l.config.Console)</span><br><span class="line">		<span class="keyword">if</span> err := console.dupStdio(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> console != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := system.Setctty(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := setupNetwork(l.config); err != <span class="literal">nil</span> &#123; <span class="comment">//初始化网络</span></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := setupRoute(l.config.Config); err != <span class="literal">nil</span> &#123; <span class="comment">//初始化route</span></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	label.Init()</span><br><span class="line">	<span class="comment">// InitializeMountNamespace() can be executed only for a new mount namespace</span></span><br><span class="line">	<span class="keyword">if</span> l.config.Config.Namespaces.Contains(configs.NEWNS) &#123;</span><br><span class="line">		<span class="keyword">if</span> err := setupRootfs(l.config.Config, console, l.pipe); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//设置hostname</span></span><br><span class="line">	<span class="keyword">if</span> hostname := l.config.Config.Hostname; hostname != <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := syscall.Sethostname([]<span class="keyword">byte</span>(hostname)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := apparmor.ApplyProfile(l.config.AppArmorProfile); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := label.SetProcessLabel(l.config.ProcessLabel); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> key, value := <span class="keyword">range</span> l.config.Config.Sysctl &#123;</span><br><span class="line">		<span class="keyword">if</span> err := writeSystemProperty(key, value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//remount只读</span></span><br><span class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> l.config.Config.ReadonlyPaths &#123;</span><br><span class="line">		<span class="keyword">if</span> err := remountReadonly(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//mask路径</span></span><br><span class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> l.config.Config.MaskPaths &#123;</span><br><span class="line">		<span class="keyword">if</span> err := maskPath(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 获取parent信号</span></span><br><span class="line">	pdeath, err := system.GetParentDeathSignal()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> l.config.NoNewPrivileges &#123;</span><br><span class="line">		<span class="keyword">if</span> err := system.Prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Tell our parent that we're ready to Execv. This must be done before the</span></span><br><span class="line">	<span class="comment">// Seccomp rules have been applied, because we need to be able to read and</span></span><br><span class="line">	<span class="comment">// write to a socket.</span></span><br><span class="line">	<span class="keyword">if</span> err := syncParentReady(l.pipe); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Without NoNewPrivileges seccomp is a privileged operation, so we need to</span></span><br><span class="line">	<span class="comment">// do this before dropping capabilities; otherwise do it as late as possible</span></span><br><span class="line">	<span class="comment">// just before execve so as few syscalls take place after it as possible.</span></span><br><span class="line">	<span class="keyword">if</span> l.config.Config.Seccomp != <span class="literal">nil</span> &amp;&amp; !l.config.NoNewPrivileges &#123;</span><br><span class="line">		<span class="keyword">if</span> err := seccomp.InitSeccomp(l.config.Config.Seccomp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := finalizeNamespace(l.config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// finalizeNamespace can change user/group which clears the parent death</span></span><br><span class="line">	<span class="comment">// signal, so we restore it here.</span></span><br><span class="line">	<span class="keyword">if</span> err := pdeath.Restore(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// compare the parent from the inital start of the init process and make sure that it did not change.</span></span><br><span class="line">	<span class="comment">// if the parent changes that means it died and we were reparented to something else so we should</span></span><br><span class="line">	<span class="comment">// just kill ourself and not cause problems for someone else.</span></span><br><span class="line">	<span class="keyword">if</span> syscall.Getppid() != l.parentPid &#123;</span><br><span class="line">		<span class="keyword">return</span> syscall.Kill(syscall.Getpid(), syscall.SIGKILL)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check for the arg before waiting to make sure it exists and it is returned</span></span><br><span class="line">	<span class="comment">// as a create time error.</span></span><br><span class="line">	name, err := exec.LookPath(l.config.Args[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// close the pipe to signal that we have completed our init.</span></span><br><span class="line">	l.pipe.Close()</span><br><span class="line">	<span class="comment">// wait for the fifo to be opened on the other side before</span></span><br><span class="line">	<span class="comment">// exec'ing the users process.</span></span><br><span class="line">	fd, err := syscall.Openat(l.stateDirFD, execFifoFilename, os.O_WRONLY|syscall.O_CLOEXEC, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"openat exec fifo"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, err := syscall.Write(fd, []<span class="keyword">byte</span>(<span class="string">"0"</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"write 0 exec fifo"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> l.config.Config.Seccomp != <span class="literal">nil</span> &amp;&amp; l.config.NoNewPrivileges &#123;</span><br><span class="line">		<span class="keyword">if</span> err := seccomp.InitSeccomp(l.config.Config.Seccomp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"init seccomp"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//系统调用</span></span><br><span class="line">	<span class="keyword">if</span> err := syscall.Exec(name, l.config.Args[<span class="number">0</span>:], os.Environ()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"exec user process"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置rootfs文件路径setupRootfs函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">setupRootfs</span><br><span class="line"><span class="comment">// setupRootfs sets up the devices, mount points, and filesystems for use inside a</span></span><br><span class="line"><span class="comment">// new mount namespace.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupRootfs</span><span class="params">(config *configs.Config, console *linuxConsole, pipe io.ReadWriter)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := prepareRoot(config); err != <span class="literal">nil</span> &#123; <span class="comment">//准备prepareRoot</span></span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"preparing rootfs"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	setupDev := needsSetupDev(config)</span><br><span class="line">	<span class="keyword">for</span> _, m := <span class="keyword">range</span> config.Mounts &#123;</span><br><span class="line">		<span class="keyword">for</span> _, precmd := <span class="keyword">range</span> m.PremountCmds &#123;</span><br><span class="line">			<span class="keyword">if</span> err := mountCmd(precmd); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"running premount command"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//mountTorootfs,挂载到rootfs</span></span><br><span class="line">		<span class="keyword">if</span> err := mountToRootfs(m, config.Rootfs, config.MountLabel); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"mounting %q to rootfs %q at %q"</span>, m.Source, config.Rootfs, m.Destination)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//mountcmd</span></span><br><span class="line">		<span class="keyword">for</span> _, postcmd := <span class="keyword">range</span> m.PostmountCmds &#123;</span><br><span class="line">			<span class="keyword">if</span> err := mountCmd(postcmd); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"running postmount command"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> setupDev &#123;</span><br><span class="line">		<span class="keyword">if</span> err := createDevices(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"creating device nodes"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := setupPtmx(config, console); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"setting up ptmx"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := setupDevSymlinks(config.Rootfs); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"setting up /dev symlinks"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Signal the parent to run the pre-start hooks.</span></span><br><span class="line">	<span class="comment">// The hooks are run after the mounts are setup, but before we switch to the new</span></span><br><span class="line">	<span class="comment">// root, so that the old root is still available in the hooks for any mount</span></span><br><span class="line">	<span class="comment">// manipulations.</span></span><br><span class="line">	<span class="keyword">if</span> err := syncParentHooks(pipe); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := syscall.Chdir(config.Rootfs); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"changing dir to %q"</span>, config.Rootfs)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.NoPivotRoot &#123;</span><br><span class="line">		err = msMoveRoot(config.Rootfs)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = pivotRoot(config.Rootfs, config.PivotDir)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"jailing process inside rootfs"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> setupDev &#123;</span><br><span class="line">		<span class="keyword">if</span> err := reOpenDevNull(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"reopening /dev/null inside container"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// remount dev as ro if specifed</span></span><br><span class="line">	<span class="keyword">for</span> _, m := <span class="keyword">range</span> config.Mounts &#123;</span><br><span class="line">		<span class="keyword">if</span> libcontainerUtils.CleanPath(m.Destination) == <span class="string">"/dev"</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> m.Flags&amp;syscall.MS_RDONLY != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> err := remountReadonly(m.Destination); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"remounting %q as readonly"</span>, m.Destination)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// set rootfs ( / ) as readonly</span></span><br><span class="line">	<span class="keyword">if</span> config.Readonlyfs &#123;</span><br><span class="line">		<span class="keyword">if</span> err := setReadonly(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"setting rootfs as readonly"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	syscall.Umask(<span class="number">0022</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init nsenter包导入：</p>
<p>在<code>runc init</code>命令的响应在文件 <strong>init.go</strong> 开头，导入 <code>nsenter</code> 包</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* init.go */</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/opencontainers/runc/libcontainer"</span></span><br><span class="line">    _ <span class="string">"github.com/opencontainers/runc/libcontainer/nsenter"</span></span><br><span class="line">    <span class="string">"github.com/urfave/cli"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>而<code>nsenter</code>包中开头通过 <code>cgo</code> 嵌入了一段 C 代码, 调用 <strong>nsexec()</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> nsenter</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">/* nsenter.go */</span></span><br><span class="line">#cgo CFLAGS: -Wall</span><br><span class="line">extern void nsexec();</span><br><span class="line">void __attribute__((constructor)) init(void) &#123;</span><br><span class="line">    nsexec();</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br><span class="line"><span class="keyword">import</span> <span class="string">"C"</span></span><br></pre></td></tr></table></figure>

<p>接下来，轮到 <strong>nsexec()</strong> 完成为容器创建新的 <code>namespace</code> 的工作了, <strong>nsexec()</strong> 同样很长，逐段来看</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* libcontainer/nsenter/nsexec.c */</span></span><br><span class="line">void nsexec(void)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> pipenum;</span><br><span class="line">    jmp_buf env;</span><br><span class="line">    <span class="keyword">int</span> sync_child_pipe[<span class="number">2</span>], sync_grandchild_pipe[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">struct</span> nlconfig_t config = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If we don't have an init pipe, just return to the go routine.</span></span><br><span class="line"><span class="comment">     * We'll only get an init pipe for start or exec.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pipenum = initpipe();</span><br><span class="line">    <span class="keyword">if</span> (pipenum == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse all of the netlink configuration. */</span></span><br><span class="line">    nl_parse(pipenum, &amp;config);</span><br><span class="line">   </span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p><strong>initpipe()</strong> 从环境中读取父进程之前设置的<code>pipe</code>(<code>_LIBCONTAINER_INITPIPE</code>记录的的文件描述符)，然后调用 <strong>nl_parse</strong> 从这个管道中读取配置到变量 <strong>config</strong> ，那么谁会往这个管道写配置呢 ? 当然就是<code>runc create</code>父进程了。父进程通过这个<code>pipe</code>，将新建容器的配置发给子进程，这个过程如下图所示:</p>
<p><img src="https://segmentfault.com/img/bVblTqN?w=866&h=256" alt="ipc"></p>
<p>子进程就从父进程处得到了<code>namespace</code>的配置，继续往下， <strong>nsexec()</strong> 又创建了两个<code>socketpair</code>,从注释中了解到，这是为了和它自己的子进程和孙进程进行通信。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nsexec</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   .....</span><br><span class="line">    <span class="comment">/* Pipe so we can tell the child when we've finished setting up. */</span></span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_LOCAL, SOCK_STREAM, <span class="number">0</span>, sync_child_pipe) &lt; <span class="number">0</span>)  <span class="comment">//  sync_child_pipe is an out parameter</span></span><br><span class="line">        bail(<span class="string">"failed to setup sync pipe between parent and child"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We need a new socketpair to sync with grandchild so we don't have</span></span><br><span class="line"><span class="comment">     * race condition with child.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_LOCAL, SOCK_STREAM, <span class="number">0</span>, sync_grandchild_pipe) &lt; <span class="number">0</span>)</span><br><span class="line">        bail(<span class="string">"failed to setup sync pipe between parent and grandchild"</span>);</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>switch case</strong> 编写的状态机,大体结构如下，当前进程通过<code>clone()</code>系统调用创建子进程，子进程又通过<code>clone()</code>系统调用创建孙进程，而实际的创建/加入<code>namespace</code>是在子进程完成的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (setjmp(env)) &#123;</span><br><span class="line">  <span class="keyword">case</span> JUMP_PARENT:&#123;</span><br><span class="line">           .....</span><br><span class="line">           clone_parent(&amp;env, JUMP_CHILD);</span><br><span class="line">           .....</span><br><span class="line">       &#125;</span><br><span class="line">  <span class="keyword">case</span> JUMP_CHILD:&#123;</span><br><span class="line">           ......</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">config</span>.namespaces)</span><br><span class="line">                join_namespaces(<span class="built_in">config</span>.namespaces);</span><br><span class="line">           clone_parent(&amp;env, JUMP_INIT);</span><br><span class="line">           ......</span><br><span class="line">       &#125;</span><br><span class="line">  <span class="keyword">case</span> JUMP_INIT:&#123;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>状态机流程：</p>
<ol>
<li><code>namespaces</code>在<code>runc init 2</code>完成创建</li>
<li><code>runc init 1</code>和<code>runc init 2</code>最终都会执行<code>exit(0)</code>,但<code>runc init 3</code>不会，它会继续执行<code>runc init</code>命令的后半部分。因此最终只会剩下<code>runc create</code>进程和<code>runc init 3</code>进程</li>
</ol>
<p><img src="https://segmentfault.com/img/bVblUmM?w=866&h=1312" alt="runc"></p>
<p>回到代码中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *initProcess)</span> <span class="title">start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    p.cmd.Start()</span><br><span class="line">    p.process.ops = p</span><br><span class="line">    io.Copy(p.parentPipe, p.bootstrapData);</span><br><span class="line"></span><br><span class="line">    p.execSetns()</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>再向 <code>runc init</code>发送了 <strong>bootstrapData</strong> 数据后，便调用 <strong>execSetns()</strong> 等待<code>runc init 1</code>进程终止，从管道中得到<code>runc init 3</code>的进程 <strong>pid</strong>,将该进程保存在 <strong>p.process.ops</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* libcontainer/process_linux.go */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *initProcess)</span> <span class="title">execSetns</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    status, err := p.cmd.Process.Wait()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pid *pid</span><br><span class="line">    json.NewDecoder(p.parentPipe).Decode(&amp;pid)</span><br><span class="line"></span><br><span class="line">    process, err := os.FindProcess(pid.Pid)</span><br><span class="line"></span><br><span class="line">    p.cmd.Process = process</span><br><span class="line">    p.process.ops = p</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-参考资料"><a href="#3-参考资料" class="headerlink" title="3. 参考资料"></a>3. 参考资料</h3><p><a href="https://segmentfault.com/a/1190000017576314?utm_source=tag-newest" target="_blank" rel="noopener">https://segmentfault.com/a/1190000017576314?utm_source=tag-newest</a></p>

      </div>
      
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-03-31T03:02:36+00:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>更新于 2020年3月31日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/runc/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>runc</p></a></div>


        
      
        
          

        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                          <h4>
                              <a href="/2020/06/19/go%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6/" rel="prev" title="go协程调度机制">
                                
                                    go协程调度机制
                                
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/golang/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> golang</a>
                              </h6>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2020/03/27/galera%E5%8E%9F%E7%90%86/" rel="prev" title="galera原理和源码学习">
                                  
                                      galera原理和源码学习
                                  
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/galera/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> galera</a>
                              </h6>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'runc原理学习',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content material'>
    
      <div class='avatar'>
        <img class='avatar' src='/images/avatar.jpg'/>
      </div>
    
    
      <div class='text'>
        
        
        
          <p><span id="jinrishici-sentence">Saar's Blog</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/fu4ck"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='material'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content material'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#runc原理学习"><span class="toc-text">runc原理学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-代码结构"><span class="toc-text">1. 代码结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-原理分析"><span class="toc-text">2. 原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-参考资料"><span class="toc-text">3. 参考资料</span></a></li></ol></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              <section class='widget grid'>
  
<header class='material'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content material'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/categories/" href="/categories/"
          
            rel="nofollow"
          
          
          id="categories">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
    </ul>
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='material'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/categories/"
    title="/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/ElasticSearch/" href="/categories/ElasticSearch/"><div class='name'>ElasticSearch</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/ctf/" href="/categories/ctf/"><div class='name'>ctf</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/docker/" href="/categories/docker/"><div class='name'>docker</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/"><div class='name'>golang</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/influxdb/" href="/categories/influxdb/"><div class='name'>influxdb</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/k8s/" href="/categories/k8s/"><div class='name'>k8s</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/malloc/" href="/categories/malloc/"><div class='name'>malloc</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/monitor/" href="/categories/monitor/"><div class='name'>monitor</div><div class='badge'>(10)</div></a></li>
        
          <li><a class="flat-box" title="/categories/mysql/" href="/categories/mysql/"><div class='name'>mysql</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/prometheus/" href="/categories/prometheus/"><div class='name'>prometheus</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/pwn/" href="/categories/pwn/"><div class='name'>pwn</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/rabbitmq/" href="/categories/rabbitmq/"><div class='name'>rabbitmq</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/redis/" href="/categories/redis/"><div class='name'>redis</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/tsdb/" href="/categories/tsdb/"><div class='name'>tsdb</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"><div class='name'>分布式</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%AD%98%E5%82%A8/" href="/categories/%E5%AD%98%E5%82%A8/"><div class='name'>存储</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><div class='name'>学习笔记</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%BF%83%E7%81%B5%E9%B8%A1%E6%B1%A4/" href="/categories/%E5%BF%83%E7%81%B5%E9%B8%A1%E6%B1%A4/"><div class='name'>心灵鸡汤</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><div class='name'>深度学习</div><div class='badge'>(2)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='material'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/tags/"
    title="/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <a href="/tags/ElasticSearch/" style="font-size: 17.33px; color: #828282">ElasticSearch</a> <a href="/tags/ctf/" style="font-size: 14px; color: #999">ctf</a> <a href="/tags/galera/" style="font-size: 14px; color: #999">galera</a> <a href="/tags/golang/" style="font-size: 17.33px; color: #828282">golang</a> <a href="/tags/influxdb/" style="font-size: 17.33px; color: #828282">influxdb</a> <a href="/tags/k8s/" style="font-size: 20.67px; color: #6c6c6c">k8s</a> <a href="/tags/malloc/" style="font-size: 17.33px; color: #828282">malloc</a> <a href="/tags/monitor/" style="font-size: 24px; color: #555">monitor</a> <a href="/tags/mysql/" style="font-size: 14px; color: #999">mysql</a> <a href="/tags/pwn/" style="font-size: 14px; color: #999">pwn</a> <a href="/tags/rabbitmq/" style="font-size: 17.33px; color: #828282">rabbitmq</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/runc/" style="font-size: 14px; color: #999">runc</a> <a href="/tags/tsdb/" style="font-size: 14px; color: #999">tsdb</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 17.33px; color: #828282">分布式</a> <a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 14px; color: #999">存储</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 14px; color: #999">学习笔记</a> <a href="/tags/%E5%BF%83%E7%81%B5%E9%B8%A1%E6%B1%A4/" style="font-size: 14px; color: #999">心灵鸡汤</a> <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 17.33px; color: #828282">深度学习</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/fu4ck"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('') {
          $('').backstretch(
          ["https://img.xjh.me/desktop/bg/nature/65253358_p0.jpg", "http://img.xjh.me/desktop/bg/nature/56245464_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63606459_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63190697_p0.jpg", "http://img.xjh.me/desktop/bg/nature/59322814_p0.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.xjh.me/desktop/bg/nature/65253358_p0.jpg", "http://img.xjh.me/desktop/bg/nature/56245464_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63606459_p0.jpg", "http://img.xjh.me/desktop/bg/nature/63190697_p0.jpg", "http://img.xjh.me/desktop/bg/nature/59322814_p0.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
